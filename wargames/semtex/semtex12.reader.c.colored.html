<a name="line1" href="#line1">  1</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;stdio.h&gt;</font></strong></font>
<a name="line2" href="#line2">  2</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;stdlib.h&gt;</font></strong></font>
<a name="line3" href="#line3">  3</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;string.h&gt;</font></strong></font>
<a name="line4" href="#line4">  4</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;sys/ipc.h&gt;</font></strong></font>
<a name="line5" href="#line5">  5</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;sys/shm.h&gt;</font></strong></font>
<a name="line6" href="#line6">  6</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;sys/types.h&gt;</font></strong></font>
<a name="line7" href="#line7">  7</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;netinet/in.h&gt;</font></strong></font>
<a name="line8" href="#line8">  8</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;arpa/inet.h&gt;</font></strong></font>
<a name="line9" href="#line9">  9</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;sys/socket.h&gt;</font></strong></font>
<a name="line10" href="#line10"> 10</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;dirent.h&gt;</font></strong></font>
<a name="line11" href="#line11"> 11</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;unistd.h&gt;</font></strong></font>
<a name="line12" href="#line12"> 12</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;signal.h&gt;</font></strong></font>
<a name="line13" href="#line13"> 13</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;wait.h&gt;</font></strong></font>
<a name="line14" href="#line14"> 14</a> 
<a name="line15" href="#line15"> 15</a> 
<a name="line16" href="#line16"> 16</a> <font color="0000ff"><strong>#include <font color="#008000">&quot;server.h&quot;</font></strong></font>
<a name="line17" href="#line17"> 17</a> <font color="0000ff"><strong>#include <font color="#008000">&quot;sem.h&quot;</font></strong></font>
<a name="line18" href="#line18"> 18</a> 
<a name="line19" href="#line19"> 19</a> <font color="0000ff"><strong>#define PATH <font color="#008000">&quot;/path&quot;</font></strong></font>
<a name="line20" href="#line20"> 20</a> <font color="0000ff"><strong>#define SHM_SIZE 4096</strong></font>
<a name="line21" href="#line21"> 21</a> <font color="0000ff"><strong>#define SHM_KEY 0xbadc0ded</strong></font>
<a name="line22" href="#line22"> 22</a> <font color="0000ff"><strong>#define AUTH_PORT 24013</strong></font>
<a name="line23" href="#line23"> 23</a> <font color="0000ff"><strong>#define BUFSIZE 512</strong></font>
<a name="line24" href="#line24"> 24</a> 
<a name="line25" href="#line25"> 25</a> <strong>int</strong> <font color="#2040a0">daemonize</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line26" href="#line26"> 26</a> 
<a name="line27" href="#line27"> 27</a> <strong>void</strong> <font color="#2040a0">list_dir</font><font color="4444FF">(</font><strong>int</strong> <font color="#2040a0">fd</font><font color="4444FF">)</font>
<a name="line28" href="#line28"> 28</a> <font color="4444FF"><strong>{</strong></font>
<a name="line29" href="#line29"> 29</a>         <font color="#2040a0">DIR</font>             <font color="4444FF">*</font><font color="#2040a0">dirp</font><font color="4444FF">;</font>
<a name="line30" href="#line30"> 30</a>         <strong>struct</strong> <font color="#2040a0">dirent</font>   <font color="4444FF">*</font><font color="#2040a0">dp</font><font color="4444FF">;</font>
<a name="line31" href="#line31"> 31</a>                 
<a name="line32" href="#line32"> 32</a>         <strong>if</strong><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">dirp</font> <font color="4444FF">=</font> <font color="#2040a0">opendir</font><font color="4444FF">(</font><font color="#2040a0">PATH</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line33" href="#line33"> 33</a>                         <strong>return</strong><font color="4444FF">;</font>
<a name="line34" href="#line34"> 34</a>         <strong>while</strong><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">dp</font> <font color="4444FF">=</font> <font color="#2040a0">readdir</font><font color="4444FF">(</font><font color="#2040a0">dirp</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line35" href="#line35"> 35</a>                 <font color="#2040a0">send</font><font color="4444FF">(</font><font color="#2040a0">fd</font>, <font color="#2040a0">dp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">d_name</font>, <font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">dp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">d_name</font><font color="4444FF">)</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line36" href="#line36"> 36</a>         <font color="4444FF"><strong>}</strong></font>
<a name="line37" href="#line37"> 37</a>         <strong>return</strong><font color="4444FF">;</font>
<a name="line38" href="#line38"> 38</a> <font color="4444FF"><strong>}</strong></font>
<a name="line39" href="#line39"> 39</a> 
<a name="line40" href="#line40"> 40</a> <strong>void</strong> <font color="#2040a0">filedump</font><font color="4444FF">(</font><strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">name</font>, <strong>int</strong> <font color="#2040a0">fd</font><font color="4444FF">)</font>
<a name="line41" href="#line41"> 41</a> <font color="4444FF"><strong>{</strong></font>
<a name="line42" href="#line42"> 42</a>         <font color="#2040a0">FILE</font>            <font color="4444FF">*</font><font color="#2040a0">filp</font><font color="4444FF">;</font>
<a name="line43" href="#line43"> 43</a>         <strong>char</strong>            <font color="#2040a0">buf</font><font color="4444FF">[</font><font color="#FF0000">2048</font><font color="4444FF">]</font><font color="4444FF">;</font>
<a name="line44" href="#line44"> 44</a>         <strong>int</strong>             <font color="#2040a0">ret</font><font color="4444FF">;</font>
<a name="line45" href="#line45"> 45</a>         
<a name="line46" href="#line46"> 46</a>         <font color="#2040a0">chdir</font><font color="4444FF">(</font><font color="#2040a0">PATH</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line47" href="#line47"> 47</a>         <strong>if</strong><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">filp</font> <font color="4444FF">=</font> <font color="#2040a0">fopen</font><font color="4444FF">(</font><font color="#2040a0">name</font>, <font color="#008000">&quot;rb&quot;</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line48" href="#line48"> 48</a>                 <font color="#2040a0">strcpy</font><font color="4444FF">(</font><font color="#2040a0">buf</font>, <font color="#008000">&quot;File not found.&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line49" href="#line49"> 49</a>                 <font color="#2040a0">send</font><font color="4444FF">(</font><font color="#2040a0">fd</font>, <font color="#2040a0">buf</font>, <font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">buf</font><font color="4444FF">)</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line50" href="#line50"> 50</a>                 <strong>return</strong><font color="4444FF">;</font>
<a name="line51" href="#line51"> 51</a>         <font color="4444FF"><strong>}</strong></font>
<a name="line52" href="#line52"> 52</a>         <strong>do</strong> <font color="4444FF"><strong>{</strong></font>
<a name="line53" href="#line53"> 53</a>                 <font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">fread</font><font color="4444FF">(</font><font color="#2040a0">buf</font>, <font color="#FF0000">1</font>, <font color="#FF0000">2048</font>, <font color="#2040a0">filp</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line54" href="#line54"> 54</a>                 <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">ret</font> <font color="4444FF">&gt;</font> <font color="#FF0000">0</font><font color="4444FF">)</font>
<a name="line55" href="#line55"> 55</a>                         <font color="#2040a0">send</font><font color="4444FF">(</font><font color="#2040a0">fd</font>, <font color="#2040a0">buf</font>, <font color="#2040a0">ret</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line56" href="#line56"> 56</a>                         <font color="#2040a0">send</font><font color="4444FF">(</font><font color="#2040a0">fd</font>, <font color="#008000">&quot;<font color="#77dd77">\n</font>&quot;</font>, <font color="#FF0000">1</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line57" href="#line57"> 57</a>         <font color="4444FF"><strong>}</strong></font> <strong>while</strong><font color="4444FF">(</font><font color="#2040a0">ret</font> <font color="4444FF">&gt;</font><font color="4444FF">=</font> <font color="#FF0000">2048</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line58" href="#line58"> 58</a> <font color="4444FF"><strong>}</strong></font>
<a name="line59" href="#line59"> 59</a> 
<a name="line60" href="#line60"> 60</a> <strong>int</strong> <font color="#2040a0">main</font><font color="4444FF">(</font><strong>int</strong> <font color="#2040a0">argc</font>, <strong>char</strong> <font color="4444FF">*</font><font color="4444FF">*</font><font color="#2040a0">argv</font><font color="4444FF">)</font>
<a name="line61" href="#line61"> 61</a> <font color="4444FF"><strong>{</strong></font>
<a name="line62" href="#line62"> 62</a> 
<a name="line63" href="#line63"> 63</a>         <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">argc</font> <font color="4444FF">&gt;</font> <font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line64" href="#line64"> 64</a>                 <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">argv</font><font color="4444FF">[</font><font color="#FF0000">1</font><font color="4444FF">]</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'D'</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line65" href="#line65"> 65</a>                         <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">daemonize</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">)</font>
<a name="line66" href="#line66"> 66</a>                                 <font color="#2040a0">exit</font><font color="4444FF">(</font><font color="#2040a0">EXIT_SUCCESS</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line67" href="#line67"> 67</a>                 <font color="4444FF"><strong>}</strong></font>
<a name="line68" href="#line68"> 68</a>         <font color="4444FF"><strong>}</strong></font>
<a name="line69" href="#line69"> 69</a>         
<a name="line70" href="#line70"> 70</a>         <strong>int</strong>                     <font color="#2040a0">sockfd</font>, <font color="#2040a0">connfd</font><font color="4444FF">;</font>
<a name="line71" href="#line71"> 71</a>         <strong>unsigned</strong> <strong>int</strong>            <font color="#2040a0">sin_size</font><font color="4444FF">;</font>
<a name="line72" href="#line72"> 72</a>         <strong>struct</strong> <font color="#2040a0">sockaddr_in</font>      <font color="#2040a0">my_addr</font>, <font color="#2040a0">remote_addr</font><font color="4444FF">;</font>
<a name="line73" href="#line73"> 73</a> 
<a name="line74" href="#line74"> 74</a>         <font color="#2040a0">key_t</font>           <font color="#2040a0">key</font> <font color="4444FF">=</font> <font color="#2040a0">SHM_KEY</font><font color="4444FF">;</font>
<a name="line75" href="#line75"> 75</a>         <strong>int</strong>             <font color="#2040a0">shmid</font><font color="4444FF">;</font>
<a name="line76" href="#line76"> 76</a>         <strong>struct</strong> <font color="#2040a0">sharea</font>   <font color="4444FF">*</font><font color="#2040a0">auth_array</font><font color="4444FF">;</font>
<a name="line77" href="#line77"> 77</a>         <strong>struct</strong> <font color="#2040a0">sigaction</font>        <font color="#2040a0">reap_zombies</font><font color="4444FF">;</font>
<a name="line78" href="#line78"> 78</a>         
<a name="line79" href="#line79"> 79</a>         <strong>char</strong>            <font color="#2040a0">sendbuf</font><font color="4444FF">[</font><font color="#2040a0">BUFSIZE</font><font color="4444FF">]</font>, <font color="#2040a0">recvbuf</font><font color="4444FF">[</font><font color="#2040a0">BUFSIZE</font><font color="4444FF">]</font>, <font color="#2040a0">filename</font><font color="4444FF">[</font><font color="#2040a0">BUFSIZE</font><font color="4444FF">]</font><font color="4444FF">;</font>
<a name="line80" href="#line80"> 80</a> 
<a name="line81" href="#line81"> 81</a>         <font color="#444444">/*Set up the shared memory authorization array */</font>
<a name="line82" href="#line82"> 82</a> 
<a name="line83" href="#line83"> 83</a>         <strong>if</strong><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">shmid</font> <font color="4444FF">=</font> <font color="#2040a0">shmget</font><font color="4444FF">(</font><font color="#2040a0">key</font>, <font color="#2040a0">SHM_SIZE</font>, <font color="#2040a0">IPC_CREAT</font> <font color="4444FF">|</font> <font color="#FF0000">0666</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line84" href="#line84"> 84</a>                 <font color="#2040a0">perror</font><font color="4444FF">(</font><font color="#008000">&quot;Shared&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line85" href="#line85"> 85</a>                 <font color="#2040a0">exit</font><font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line86" href="#line86"> 86</a>         <font color="4444FF"><strong>}</strong></font>
<a name="line87" href="#line87"> 87</a> 
<a name="line88" href="#line88"> 88</a>         <strong>if</strong><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">auth_array</font> <font color="4444FF">=</font> <font color="#2040a0">shmat</font><font color="4444FF">(</font><font color="#2040a0">shmid</font>, <font color="#2040a0">NULL</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line89" href="#line89"> 89</a>                 <font color="#2040a0">perror</font><font color="4444FF">(</font><font color="#008000">&quot;Share attach&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line90" href="#line90"> 90</a>                 <font color="#2040a0">exit</font><font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line91" href="#line91"> 91</a>         <font color="4444FF"><strong>}</strong></font>
<a name="line92" href="#line92"> 92</a> 
<a name="line93" href="#line93"> 93</a>         <font color="#444444">/* Lets set up the listening socket */</font>
<a name="line94" href="#line94"> 94</a> 
<a name="line95" href="#line95"> 95</a>         <font color="#2040a0">memset</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">reap_zombies</font>, <font color="#FF0000">0</font>, <strong>sizeof</strong><font color="4444FF">(</font><font color="#2040a0">reap_zombies</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line96" href="#line96"> 96</a>         <font color="#2040a0">reap_zombies</font>.<font color="#2040a0">sa_flags</font> <font color="4444FF">=</font> <font color="#2040a0">SA_NOCLDWAIT</font><font color="4444FF">;</font>
<a name="line97" href="#line97"> 97</a> 
<a name="line98" href="#line98"> 98</a>         <strong>if</strong><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">sigaction</font><font color="4444FF">(</font><font color="#2040a0">SIGCHLD</font>, <font color="4444FF">&amp;</font><font color="#2040a0">reap_zombies</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line99" href="#line99"> 99</a>                 <font color="#2040a0">perror</font><font color="4444FF">(</font><font color="#008000">&quot;Sighandler&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line100" href="#line100">100</a>                 <font color="#2040a0">exit</font><font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line101" href="#line101">101</a>         <font color="4444FF"><strong>}</strong></font>
<a name="line102" href="#line102">102</a> 
<a name="line103" href="#line103">103</a>         <strong>if</strong><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">sockfd</font> <font color="4444FF">=</font> <font color="#2040a0">socket</font><font color="4444FF">(</font><font color="#2040a0">PF_INET</font>, <font color="#2040a0">SOCK_STREAM</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line104" href="#line104">104</a>                 <font color="#2040a0">perror</font><font color="4444FF">(</font><font color="#008000">&quot;Socket&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line105" href="#line105">105</a>                 <font color="#2040a0">exit</font><font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line106" href="#line106">106</a>         <font color="4444FF"><strong>}</strong></font>
<a name="line107" href="#line107">107</a>         <font color="#2040a0">my_addr</font>.<font color="#2040a0">sin_family</font> <font color="4444FF">=</font> <font color="#2040a0">AF_INET</font><font color="4444FF">;</font>
<a name="line108" href="#line108">108</a>         <font color="#2040a0">my_addr</font>.<font color="#2040a0">sin_port</font> <font color="4444FF">=</font> <font color="#2040a0">htons</font><font color="4444FF">(</font><font color="#2040a0">AUTH_PORT</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line109" href="#line109">109</a>         <font color="#2040a0">my_addr</font>.<font color="#2040a0">sin_addr</font>.<font color="#2040a0">s_addr</font> <font color="4444FF">=</font> <font color="#2040a0">htonl</font><font color="4444FF">(</font><font color="#2040a0">INADDR_ANY</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line110" href="#line110">110</a>         <font color="#2040a0">memset</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="4444FF">(</font><font color="#2040a0">my_addr</font>.<font color="#2040a0">sin_zero</font><font color="4444FF">)</font>, <font color="#008000">'<font color="#77dd77">\0</font>'</font>, <font color="#FF0000">8</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line111" href="#line111">111</a> 
<a name="line112" href="#line112">112</a>         <strong>if</strong><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">bind</font><font color="4444FF">(</font><font color="#2040a0">sockfd</font>, <font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">sockaddr</font> <font color="4444FF">*</font><font color="4444FF">)</font><font color="4444FF">&amp;</font><font color="#2040a0">my_addr</font>, <strong>sizeof</strong><font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">sockaddr</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line113" href="#line113">113</a>                 <font color="#2040a0">perror</font><font color="4444FF">(</font><font color="#008000">&quot;Bind&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line114" href="#line114">114</a>                 <font color="#2040a0">exit</font><font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line115" href="#line115">115</a>         <font color="4444FF"><strong>}</strong></font>
<a name="line116" href="#line116">116</a> 
<a name="line117" href="#line117">117</a>         <font color="#2040a0">listen</font><font color="4444FF">(</font><font color="#2040a0">sockfd</font>, <font color="#FF0000">5</font><font color="4444FF">)</font><font color="4444FF">;</font>      <font color="#444444">/* Error checks... nah! */</font>
<a name="line118" href="#line118">118</a>         
<a name="line119" href="#line119">119</a>         <strong>while</strong><font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line120" href="#line120">120</a> 
<a name="line121" href="#line121">121</a>                 <strong>int</strong> <font color="#2040a0">i</font>, <font color="#2040a0">len</font>, <font color="#2040a0">pid</font>, <font color="#2040a0">found</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line122" href="#line122">122</a> 
<a name="line123" href="#line123">123</a>                 <font color="#2040a0">sin_size</font> <font color="4444FF">=</font> <strong>sizeof</strong><font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">sockaddr_in</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line124" href="#line124">124</a>                 <strong>if</strong><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">connfd</font> <font color="4444FF">=</font> <font color="#2040a0">accept</font><font color="4444FF">(</font><font color="#2040a0">sockfd</font>, <font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">sockaddr</font><font color="4444FF">*</font><font color="4444FF">)</font><font color="4444FF">&amp;</font><font color="#2040a0">remote_addr</font>, <font color="4444FF">&amp;</font><font color="#2040a0">sin_size</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line125" href="#line125">125</a>                         <font color="#2040a0">perror</font><font color="4444FF">(</font><font color="#008000">&quot;Accept&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line126" href="#line126">126</a>                         <font color="#2040a0">exit</font><font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line127" href="#line127">127</a>                 <font color="4444FF"><strong>}</strong></font>
<a name="line128" href="#line128">128</a>                 
<a name="line129" href="#line129">129</a>                 <strong>if</strong><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">pid</font> <font color="4444FF">=</font> <font color="#2040a0">fork</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line130" href="#line130">130</a>                         <font color="#2040a0">perror</font><font color="4444FF">(</font><font color="#008000">&quot;fork&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line131" href="#line131">131</a>                         <font color="#2040a0">exit</font><font color="4444FF">(</font><font color="#2040a0">EXIT_FAILURE</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line132" href="#line132">132</a>                 <font color="4444FF"><strong>}</strong></font>
<a name="line133" href="#line133">133</a>                 <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">pid</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line134" href="#line134">134</a>                         <font color="#2040a0">close</font><font color="4444FF">(</font><font color="#2040a0">connfd</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line135" href="#line135">135</a>                         <strong>continue</strong><font color="4444FF">;</font>
<a name="line136" href="#line136">136</a>                 <font color="4444FF"><strong>}</strong></font>
<a name="line137" href="#line137">137</a>                 
<a name="line138" href="#line138">138</a>                 <font color="#2040a0">strcpy</font><font color="4444FF">(</font><font color="#2040a0">sendbuf</font>, <font color="#008000">&quot;File Transfer: Enter 'l' for list or type a filename:&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line139" href="#line139">139</a>                 <font color="#2040a0">send</font><font color="4444FF">(</font><font color="#2040a0">connfd</font>, <font color="#2040a0">sendbuf</font>, <font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">sendbuf</font><font color="4444FF">)</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line140" href="#line140">140</a>                 <font color="#2040a0">len</font> <font color="4444FF">=</font> <font color="#2040a0">recv</font><font color="4444FF">(</font><font color="#2040a0">connfd</font>, <font color="#2040a0">recvbuf</font>, <font color="#2040a0">BUFSIZE</font> <font color="4444FF">-</font> <font color="#FF0000">1</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line141" href="#line141">141</a>                 
<a name="line142" href="#line142">142</a>                 <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">len</font> <font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">)</font>
<a name="line143" href="#line143">143</a>                         <strong>break</strong><font color="4444FF">;</font>
<a name="line144" href="#line144">144</a>                 
<a name="line145" href="#line145">145</a>                 <font color="#2040a0">strncpy</font><font color="4444FF">(</font><font color="#2040a0">filename</font>, <font color="#2040a0">recvbuf</font>, <font color="#2040a0">len</font> <font color="4444FF">&lt;</font> <font color="#2040a0">BUFSIZE</font> ? <font color="#2040a0">len</font> <font color="4444FF">:</font> <font color="#2040a0">BUFSIZE</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line146" href="#line146">146</a>                 <font color="#2040a0">filename</font><font color="4444FF">[</font><font color="#2040a0">BUFSIZE</font> <font color="4444FF">-</font> <font color="#FF0000">1</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#008000">'<font color="#77dd77">\0</font>'</font><font color="4444FF">;</font>
<a name="line147" href="#line147">147</a> 
<a name="line148" href="#line148">148</a>                 <font color="#2040a0">down</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">auth_array</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">sem</font><font color="4444FF">)</font><font color="4444FF">;</font> <font color="#444444">/* Take semaphore for reading auth list */</font>
<a name="line149" href="#line149">149</a>                 <strong>for</strong><font color="4444FF">(</font><font color="#2040a0">i</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <font color="#2040a0">i</font> <font color="4444FF">&lt;</font> <font color="#FF0000">32</font><font color="4444FF">;</font> <font color="#2040a0">i</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line150" href="#line150">150</a>                         <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">auth_array</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">list</font><font color="4444FF">[</font><font color="#2040a0">i</font><font color="4444FF">]</font>.<font color="#2040a0">token</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">remote_addr</font>.<font color="#2040a0">sin_addr</font>.<font color="#2040a0">s_addr</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line151" href="#line151">151</a>                                 <font color="#2040a0">found</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">;</font>
<a name="line152" href="#line152">152</a>                                 <strong>break</strong><font color="4444FF">;</font>
<a name="line153" href="#line153">153</a>                         <font color="4444FF"><strong>}</strong></font>
<a name="line154" href="#line154">154</a>                 <font color="4444FF"><strong>}</strong></font>
<a name="line155" href="#line155">155</a>                 <font color="#2040a0">up</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">auth_array</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">sem</font><font color="4444FF">)</font><font color="4444FF">;</font> <font color="#444444">/* Release semaphore to wait on user replies next... avoid deadlock */</font>
<a name="line156" href="#line156">156</a> 
<a name="line157" href="#line157">157</a>                 <strong>if</strong><font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">found</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line158" href="#line158">158</a>                         <font color="#2040a0">strcpy</font><font color="4444FF">(</font><font color="#2040a0">sendbuf</font>, <font color="#008000">&quot;Not recognized, use authd first.&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line159" href="#line159">159</a>                         <font color="#2040a0">send</font><font color="4444FF">(</font><font color="#2040a0">connfd</font>, <font color="#2040a0">sendbuf</font>, <font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">sendbuf</font><font color="4444FF">)</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line160" href="#line160">160</a>                         <font color="#2040a0">close</font><font color="4444FF">(</font><font color="#2040a0">connfd</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line161" href="#line161">161</a>                         <strong>continue</strong><font color="4444FF">;</font>
<a name="line162" href="#line162">162</a>                 <font color="4444FF"><strong>}</strong></font>
<a name="line163" href="#line163">163</a>                 
<a name="line164" href="#line164">164</a>                 <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">filename</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'l'</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line165" href="#line165">165</a>                         <font color="#2040a0">list_dir</font><font color="4444FF">(</font><font color="#2040a0">connfd</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line166" href="#line166">166</a>                 <font color="4444FF"><strong>}</strong></font>
<a name="line167" href="#line167">167</a>                 <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
<a name="line168" href="#line168">168</a>                         <font color="#2040a0">strcpy</font><font color="4444FF">(</font><font color="#2040a0">sendbuf</font>, <font color="#008000">&quot;Display file? (y/n)&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line169" href="#line169">169</a>                         <font color="#444444">/*check perm and display file*/</font>
<a name="line170" href="#line170">170</a>                         
<a name="line171" href="#line171">171</a>                         <font color="#2040a0">send</font><font color="4444FF">(</font><font color="#2040a0">connfd</font>, <font color="#2040a0">sendbuf</font>, <font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">sendbuf</font><font color="4444FF">)</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line172" href="#line172">172</a>                         <font color="#2040a0">recv</font><font color="4444FF">(</font><font color="#2040a0">connfd</font>, <font color="#2040a0">recvbuf</font>, <font color="#2040a0">BUFSIZE</font> <font color="4444FF">-</font> <font color="#FF0000">1</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line173" href="#line173">173</a>                         <font color="#2040a0">recvbuf</font><font color="4444FF">[</font><font color="#2040a0">BUFSIZE</font> <font color="4444FF">-</font> <font color="#FF0000">1</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#008000">'<font color="#77dd77">\0</font>'</font><font color="4444FF">;</font>
<a name="line174" href="#line174">174</a>                         
<a name="line175" href="#line175">175</a>                         <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">recvbuf</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'y'</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line176" href="#line176">176</a>                                 <font color="#2040a0">down</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">auth_array</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">sem</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line177" href="#line177">177</a>                                 <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">auth_array</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">list</font><font color="4444FF">[</font><font color="#2040a0">i</font><font color="4444FF">]</font>.<font color="#2040a0">perms</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font><font color="#444444">/* 0 is superuser, 1 is user */</font>
<a name="line178" href="#line178">178</a>                                         <font color="#2040a0">filedump</font><font color="4444FF">(</font><font color="#2040a0">filename</font>, <font color="#2040a0">connfd</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line179" href="#line179">179</a>                                 <font color="4444FF"><strong>}</strong></font>
<a name="line180" href="#line180">180</a>                                 <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
<a name="line181" href="#line181">181</a>                                         <font color="#2040a0">strcpy</font><font color="4444FF">(</font><font color="#2040a0">sendbuf</font>, <font color="#008000">&quot;Not Authorized&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line182" href="#line182">182</a>                                         <font color="#2040a0">send</font><font color="4444FF">(</font><font color="#2040a0">connfd</font>, <font color="#2040a0">sendbuf</font>, <font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">sendbuf</font><font color="4444FF">)</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line183" href="#line183">183</a>                                 <font color="4444FF"><strong>}</strong></font>
<a name="line184" href="#line184">184</a>                                 <font color="#2040a0">up</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">auth_array</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">sem</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line185" href="#line185">185</a>                         <font color="4444FF"><strong>}</strong></font>
<a name="line186" href="#line186">186</a> 
<a name="line187" href="#line187">187</a>                 <font color="4444FF"><strong>}</strong></font>
<a name="line188" href="#line188">188</a>                 <font color="#2040a0">close</font><font color="4444FF">(</font><font color="#2040a0">connfd</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line189" href="#line189">189</a>                 <font color="#2040a0">exit</font><font color="4444FF">(</font><font color="#2040a0">EXIT_SUCCESS</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line190" href="#line190">190</a>         <font color="4444FF"><strong>}</strong></font>
<a name="line191" href="#line191">191</a>         <strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line192" href="#line192">192</a> <font color="4444FF"><strong>}</strong></font>
