<a name="line1" href="#line1"> 1</a> <strong>void</strong> <font color="#2040a0">prepare_key</font><font color="4444FF">(</font><strong>unsigned</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">key_data_ptr</font>, <strong>int</strong> <font color="#2040a0">key_data_len</font>, <font color="#2040a0">rc4_key</font> <font color="4444FF">*</font><font color="#2040a0">key</font><font color="4444FF">)</font>
<a name="line2" href="#line2"> 2</a> <font color="4444FF"><strong>{</strong></font>
<a name="line3" href="#line3"> 3</a>     <strong>int</strong> <font color="#2040a0">i</font><font color="4444FF">;</font>
<a name="line4" href="#line4"> 4</a>     <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">t</font><font color="4444FF">;</font>
<a name="line5" href="#line5"> 5</a>     <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">swapByte</font><font color="4444FF">;</font>
<a name="line6" href="#line6"> 6</a>     <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">index1</font><font color="4444FF">;</font>
<a name="line7" href="#line7"> 7</a>     <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">index2</font><font color="4444FF">;</font>
<a name="line8" href="#line8"> 8</a>     <strong>unsigned</strong> <strong>char</strong><font color="4444FF">*</font> <font color="#2040a0">state</font><font color="4444FF">;</font>
<a name="line9" href="#line9"> 9</a>     <strong>short</strong> <font color="#2040a0">counter</font><font color="4444FF">;</font>
<a name="line10" href="#line10">10</a> 
<a name="line11" href="#line11">11</a>     <font color="#2040a0">state</font> <font color="4444FF">=</font> <font color="4444FF">&amp;</font><font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font><font color="4444FF">;</font>
<a name="line12" href="#line12">12</a>     <strong>for</strong><font color="4444FF">(</font><font color="#2040a0">counter</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <font color="#2040a0">counter</font> <font color="4444FF">&lt;</font> <font color="#FF0000">256</font><font color="4444FF">;</font> <font color="#2040a0">counter</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font>
<a name="line13" href="#line13">13</a>         <font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">counter</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">counter</font><font color="4444FF">;</font>
<a name="line14" href="#line14">14</a>     <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">x</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line15" href="#line15">15</a>     <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">y</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line16" href="#line16">16</a>     <font color="#2040a0">index1</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line17" href="#line17">17</a>     <font color="#2040a0">index2</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line18" href="#line18">18</a>     <strong>for</strong><font color="4444FF">(</font><font color="#2040a0">counter</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <font color="#2040a0">counter</font> <font color="4444FF">&lt;</font> <font color="#FF0000">256</font><font color="4444FF">;</font> <font color="#2040a0">counter</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font>
<a name="line19" href="#line19">19</a>     <font color="4444FF"><strong>{</strong></font>
<a name="line20" href="#line20">20</a>         <font color="#2040a0">index2</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">key_data_ptr</font><font color="4444FF">[</font><font color="#2040a0">index1</font><font color="4444FF">]</font> <font color="4444FF">+</font> <font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">counter</font><font color="4444FF">]</font> <font color="4444FF">+</font> <font color="#2040a0">index2</font><font color="4444FF">)</font> <font color="4444FF">%</font> <font color="#FF0000">256</font><font color="4444FF">;</font>
<a name="line21" href="#line21">21</a>         <font color="#2040a0">swap_byte</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">counter</font><font color="4444FF">]</font>, <font color="4444FF">&amp;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">index2</font><font color="4444FF">]</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line22" href="#line22">22</a>         <font color="#2040a0">index1</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">index1</font> <font color="4444FF">+</font> <font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF">%</font> <font color="#2040a0">key_data_len</font><font color="4444FF">;</font>
<a name="line23" href="#line23">23</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line24" href="#line24">24</a> <font color="4444FF"><strong>}</strong></font>
<a name="line25" href="#line25">25</a> 
<a name="line26" href="#line26">26</a> <strong>void</strong> <font color="#2040a0">rc4</font><font color="4444FF">(</font><strong>unsigned</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">buffer_ptr</font>, <strong>int</strong> <font color="#2040a0">buffer_len</font>, <font color="#2040a0">rc4_key</font> <font color="4444FF">*</font><font color="#2040a0">key</font><font color="4444FF">)</font>
<a name="line27" href="#line27">27</a> <font color="4444FF"><strong>{</strong></font>
<a name="line28" href="#line28">28</a>     <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">t</font><font color="4444FF">;</font>
<a name="line29" href="#line29">29</a>     <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">x</font><font color="4444FF">;</font>
<a name="line30" href="#line30">30</a>     <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">y</font><font color="4444FF">;</font>
<a name="line31" href="#line31">31</a>     <strong>unsigned</strong> <strong>char</strong><font color="4444FF">*</font> <font color="#2040a0">state</font><font color="4444FF">;</font>
<a name="line32" href="#line32">32</a>     <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">xorIndex</font><font color="4444FF">;</font>
<a name="line33" href="#line33">33</a>     <strong>short</strong> <font color="#2040a0">counter</font><font color="4444FF">;</font>
<a name="line34" href="#line34">34</a> 
<a name="line35" href="#line35">35</a>     <font color="#2040a0">x</font> <font color="4444FF">=</font> <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">x</font><font color="4444FF">;</font>
<a name="line36" href="#line36">36</a>     <font color="#2040a0">y</font> <font color="4444FF">=</font> <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">y</font><font color="4444FF">;</font>
<a name="line37" href="#line37">37</a>     <font color="#2040a0">state</font> <font color="4444FF">=</font> <font color="4444FF">&amp;</font><font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font><font color="4444FF">;</font>
<a name="line38" href="#line38">38</a>     <strong>for</strong><font color="4444FF">(</font><font color="#2040a0">counter</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <font color="#2040a0">counter</font> <font color="4444FF">&lt;</font> <font color="#2040a0">buffer_len</font><font color="4444FF">;</font> <font color="#2040a0">counter</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font>
<a name="line39" href="#line39">39</a>     <font color="4444FF"><strong>{</strong></font>
<a name="line40" href="#line40">40</a>         <font color="#2040a0">x</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">x</font> <font color="4444FF">+</font> <font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF">%</font> <font color="#FF0000">256</font><font color="4444FF">;</font>
<a name="line41" href="#line41">41</a>         <font color="#2040a0">y</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">x</font><font color="4444FF">]</font> <font color="4444FF">+</font> <font color="#2040a0">y</font><font color="4444FF">)</font> <font color="4444FF">%</font> <font color="#FF0000">256</font><font color="4444FF">;</font>
<a name="line42" href="#line42">42</a>         <font color="#2040a0">swap_byte</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">x</font><font color="4444FF">]</font>, <font color="4444FF">&amp;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">y</font><font color="4444FF">]</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line43" href="#line43">43</a>         <font color="#2040a0">xorIndex</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">x</font><font color="4444FF">]</font> <font color="4444FF">+</font> <font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">y</font><font color="4444FF">]</font><font color="4444FF">)</font> <font color="4444FF">%</font> <font color="#FF0000">256</font><font color="4444FF">;</font>
<a name="line44" href="#line44">44</a>         <font color="#2040a0">buffer_ptr</font><font color="4444FF">[</font><font color="#2040a0">counter</font><font color="4444FF">]</font> ^<font color="4444FF">=</font> <font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">xorIndex</font><font color="4444FF">]</font><font color="4444FF">;</font>
<a name="line45" href="#line45">45</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line46" href="#line46">46</a>     <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">x</font> <font color="4444FF">=</font> <font color="#2040a0">x</font><font color="4444FF">;</font>
<a name="line47" href="#line47">47</a>     <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">y</font> <font color="4444FF">=</font> <font color="#2040a0">y</font><font color="4444FF">;</font>
<a name="line48" href="#line48">48</a> <font color="4444FF"><strong>}</strong></font>
