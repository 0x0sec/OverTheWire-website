<pre>
<strong>void</strong> <font color="#2040a0">prepare_key</font><font color="4444FF">(</font><strong>unsigned</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">key_data_ptr</font>, <strong>int</strong> <font color="#2040a0">key_data_len</font>, <font color="#2040a0">rc4_key</font> <font color="4444FF">*</font><font color="#2040a0">key</font><font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
    <strong>int</strong> <font color="#2040a0">i</font><font color="4444FF">;</font>
    <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">t</font><font color="4444FF">;</font>
    <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">swapByte</font><font color="4444FF">;</font>
    <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">index1</font><font color="4444FF">;</font>
    <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">index2</font><font color="4444FF">;</font>
    <strong>unsigned</strong> <strong>char</strong><font color="4444FF">*</font> <font color="#2040a0">state</font><font color="4444FF">;</font>
    <strong>short</strong> <font color="#2040a0">counter</font><font color="4444FF">;</font>

    <font color="#2040a0">state</font> <font color="4444FF">=</font> <font color="4444FF">&amp;</font><font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font><font color="4444FF">;</font>
    <strong>for</strong><font color="4444FF">(</font><font color="#2040a0">counter</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <font color="#2040a0">counter</font> <font color="4444FF">&lt;</font> <font color="#FF0000">256</font><font color="4444FF">;</font> <font color="#2040a0">counter</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font>
        <font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">counter</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">counter</font><font color="4444FF">;</font>
    <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">x</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
    <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">y</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
    <font color="#2040a0">index1</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
    <font color="#2040a0">index2</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
    <strong>for</strong><font color="4444FF">(</font><font color="#2040a0">counter</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <font color="#2040a0">counter</font> <font color="4444FF">&lt;</font> <font color="#FF0000">256</font><font color="4444FF">;</font> <font color="#2040a0">counter</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font>
    <font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">index2</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">key_data_ptr</font><font color="4444FF">[</font><font color="#2040a0">index1</font><font color="4444FF">]</font> <font color="4444FF">+</font> <font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">counter</font><font color="4444FF">]</font> <font color="4444FF">+</font> <font color="#2040a0">index2</font><font color="4444FF">)</font> <font color="4444FF">%</font> <font color="#FF0000">256</font><font color="4444FF">;</font>
        <font color="#2040a0">swap_byte</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">counter</font><font color="4444FF">]</font>, <font color="4444FF">&amp;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">index2</font><font color="4444FF">]</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <font color="#2040a0">index1</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">index1</font> <font color="4444FF">+</font> <font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF">%</font> <font color="#2040a0">key_data_len</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>
<font color="4444FF"><strong>}</strong></font>

<strong>void</strong> <font color="#2040a0">rc4</font><font color="4444FF">(</font><strong>unsigned</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">buffer_ptr</font>, <strong>int</strong> <font color="#2040a0">buffer_len</font>, <font color="#2040a0">rc4_key</font> <font color="4444FF">*</font><font color="#2040a0">key</font><font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
    <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">t</font><font color="4444FF">;</font>
    <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">x</font><font color="4444FF">;</font>
    <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">y</font><font color="4444FF">;</font>
    <strong>unsigned</strong> <strong>char</strong><font color="4444FF">*</font> <font color="#2040a0">state</font><font color="4444FF">;</font>
    <strong>unsigned</strong> <strong>char</strong> <font color="#2040a0">xorIndex</font><font color="4444FF">;</font>
    <strong>short</strong> <font color="#2040a0">counter</font><font color="4444FF">;</font>

    <font color="#2040a0">x</font> <font color="4444FF">=</font> <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">x</font><font color="4444FF">;</font>
    <font color="#2040a0">y</font> <font color="4444FF">=</font> <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">y</font><font color="4444FF">;</font>
    <font color="#2040a0">state</font> <font color="4444FF">=</font> <font color="4444FF">&amp;</font><font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font><font color="4444FF">;</font>
    <strong>for</strong><font color="4444FF">(</font><font color="#2040a0">counter</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <font color="#2040a0">counter</font> <font color="4444FF">&lt;</font> <font color="#2040a0">buffer_len</font><font color="4444FF">;</font> <font color="#2040a0">counter</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font>
    <font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">x</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">x</font> <font color="4444FF">+</font> <font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF">%</font> <font color="#FF0000">256</font><font color="4444FF">;</font>
        <font color="#2040a0">y</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">x</font><font color="4444FF">]</font> <font color="4444FF">+</font> <font color="#2040a0">y</font><font color="4444FF">)</font> <font color="4444FF">%</font> <font color="#FF0000">256</font><font color="4444FF">;</font>
        <font color="#2040a0">swap_byte</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">x</font><font color="4444FF">]</font>, <font color="4444FF">&amp;</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">y</font><font color="4444FF">]</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <font color="#2040a0">xorIndex</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">x</font><font color="4444FF">]</font> <font color="4444FF">+</font> <font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">y</font><font color="4444FF">]</font><font color="4444FF">)</font> <font color="4444FF">%</font> <font color="#FF0000">256</font><font color="4444FF">;</font>
        <font color="#2040a0">buffer_ptr</font><font color="4444FF">[</font><font color="#2040a0">counter</font><font color="4444FF">]</font> ^<font color="4444FF">=</font> <font color="#2040a0">state</font><font color="4444FF">[</font><font color="#2040a0">xorIndex</font><font color="4444FF">]</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>
    <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">x</font> <font color="4444FF">=</font> <font color="#2040a0">x</font><font color="4444FF">;</font>
    <font color="#2040a0">key</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">y</font> <font color="4444FF">=</font> <font color="#2040a0">y</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

</pre>
