<a name="line1" href="#line1">   1</a> <font color="#444444">/*
<a name="line2" href="#line2">   2</a>  * ----------------------------------------------------------------------------
<a name="line3" href="#line3">   3</a>  * &quot;THE BEER-WARE LICENSE&quot; (Revision 42):
<a name="line4" href="#line4">   4</a>  * &lt;phk@FreeBSD.ORG&gt; wrote this file.  As long as you retain this notice you
<a name="line5" href="#line5">   5</a>  * can do whatever you want with this stuff. If we meet some day, and you think
<a name="line6" href="#line6">   6</a>  * this stuff is worth it, you can buy me a beer in return.   Poul-Henning Kamp
<a name="line7" href="#line7">   7</a>  * ----------------------------------------------------------------------------
<a name="line8" href="#line8">   8</a>  *
<a name="line9" href="#line9">   9</a>  */</font>
<a name="line10" href="#line10">  10</a> 
<a name="line11" href="#line11">  11</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;sys/cdefs.h&gt;</font></strong></font>
<a name="line12" href="#line12">  12</a> // <font color="#2040a0">__FBSDID</font><font color="4444FF">(</font><font color="#008000">&quot;$FreeBSD: /repoman/r/ncvs/src/lib/libc/stdlib/malloc.c,v 1.87 2004/03/07 20:41:27 phk Exp $&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line13" href="#line13">  13</a> 
<a name="line14" href="#line14">  14</a> <font color="#444444">/*
<a name="line15" href="#line15">  15</a>  * Defining MALLOC_EXTRA_SANITY will enable extra checks which are related
<a name="line16" href="#line16">  16</a>  * to internal conditions and consistency in malloc.c. This has a
<a name="line17" href="#line17">  17</a>  * noticeable runtime performance hit, and generally will not do you
<a name="line18" href="#line18">  18</a>  * any good unless you fiddle with the internals of malloc or want
<a name="line19" href="#line19">  19</a>  * to catch random pointer corruption as early as possible.
<a name="line20" href="#line20">  20</a>  */</font>
<a name="line21" href="#line21">  21</a> <font color="0000ff"><strong>#ifndef MALLOC_EXTRA_SANITY</strong></font>
<a name="line22" href="#line22">  22</a> <font color="0000ff"><strong>#undef MALLOC_EXTRA_SANITY</strong></font>
<a name="line23" href="#line23">  23</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line24" href="#line24">  24</a> 
<a name="line25" href="#line25">  25</a> <font color="0000ff"><strong>#define EDOOFUS -1</strong></font>
<a name="line26" href="#line26">  26</a> 
<a name="line27" href="#line27">  27</a> <font color="#444444">/*
<a name="line28" href="#line28">  28</a>  * What to use for Junk.  This is the byte value we use to fill with
<a name="line29" href="#line29">  29</a>  * when the 'J' option is enabled.
<a name="line30" href="#line30">  30</a>  */</font>
<a name="line31" href="#line31">  31</a> <font color="0000ff"><strong>#define SOME_JUNK	0xd0	<font color="#444444">	/* as in &quot;Duh&quot; :-) */</font></strong></font>
<a name="line32" href="#line32">  32</a> 
<a name="line33" href="#line33">  33</a> <font color="#444444">/*
<a name="line34" href="#line34">  34</a>  * The basic parameters you can tweak.
<a name="line35" href="#line35">  35</a>  *
<a name="line36" href="#line36">  36</a>  * malloc_pageshift	pagesize = 1 &lt;&lt; malloc_pageshift
<a name="line37" href="#line37">  37</a>  *			It's probably best if this is the native
<a name="line38" href="#line38">  38</a>  *			page size, but it doesn't have to be.
<a name="line39" href="#line39">  39</a>  *
<a name="line40" href="#line40">  40</a>  * malloc_minsize	minimum size of an allocation in bytes.
<a name="line41" href="#line41">  41</a>  *			If this is too small it's too much work
<a name="line42" href="#line42">  42</a>  *			to manage them.  This is also the smallest
<a name="line43" href="#line43">  43</a>  *			unit of alignment used for the storage
<a name="line44" href="#line44">  44</a>  *			returned by malloc/realloc.
<a name="line45" href="#line45">  45</a>  *
<a name="line46" href="#line46">  46</a>  */</font>
<a name="line47" href="#line47">  47</a> 
<a name="line48" href="#line48">  48</a> <font color="0000ff"><strong>#if defined(__FreeBSD__)</strong></font>
<a name="line49" href="#line49">  49</a> <font color="0000ff"><strong>#   if defined(__i386__)</strong></font>
<a name="line50" href="#line50">  50</a> <font color="0000ff"><strong>#       define malloc_pageshift		12U</strong></font>
<a name="line51" href="#line51">  51</a> <font color="0000ff"><strong>#       define malloc_minsize		16U</strong></font>
<a name="line52" href="#line52">  52</a> <font color="0000ff"><strong>#   endif</strong></font>
<a name="line53" href="#line53">  53</a> <font color="0000ff"><strong>#   if defined(__ia64__)</strong></font>
<a name="line54" href="#line54">  54</a> <font color="0000ff"><strong>#	define malloc_pageshift		13U</strong></font>
<a name="line55" href="#line55">  55</a> <font color="0000ff"><strong>#	define malloc_minsize		16U</strong></font>
<a name="line56" href="#line56">  56</a> <font color="0000ff"><strong>#   endif</strong></font>
<a name="line57" href="#line57">  57</a> <font color="0000ff"><strong>#   if defined(__alpha__)</strong></font>
<a name="line58" href="#line58">  58</a> <font color="0000ff"><strong>#       define malloc_pageshift		13U</strong></font>
<a name="line59" href="#line59">  59</a> <font color="0000ff"><strong>#       define malloc_minsize		16U</strong></font>
<a name="line60" href="#line60">  60</a> <font color="0000ff"><strong>#   endif</strong></font>
<a name="line61" href="#line61">  61</a> <font color="0000ff"><strong>#   if defined(__sparc64__)</strong></font>
<a name="line62" href="#line62">  62</a> <font color="0000ff"><strong>#       define malloc_pageshift		13U</strong></font>
<a name="line63" href="#line63">  63</a> <font color="0000ff"><strong>#       define malloc_minsize		16U</strong></font>
<a name="line64" href="#line64">  64</a> <font color="0000ff"><strong>#   endif</strong></font>
<a name="line65" href="#line65">  65</a> <font color="0000ff"><strong>#   if defined(__amd64__)</strong></font>
<a name="line66" href="#line66">  66</a> <font color="0000ff"><strong>#       define malloc_pageshift		12U</strong></font>
<a name="line67" href="#line67">  67</a> <font color="0000ff"><strong>#       define malloc_minsize		16U</strong></font>
<a name="line68" href="#line68">  68</a> <font color="0000ff"><strong>#   endif</strong></font>
<a name="line69" href="#line69">  69</a> <font color="0000ff"><strong>#   define HAS_UTRACE</strong></font>
<a name="line70" href="#line70">  70</a>     <font color="#444444">/*
<a name="line71" href="#line71">  71</a>      * Make malloc/free/realloc thread-safe in libc for use with
<a name="line72" href="#line72">  72</a>      * kernel threads.
<a name="line73" href="#line73">  73</a>      */</font>
<a name="line74" href="#line74">  74</a> <font color="0000ff"><strong>#   include <font color="#008000">&quot;libc_private.h&quot;</font></strong></font>
<a name="line75" href="#line75">  75</a> <font color="0000ff"><strong>#   include <font color="#008000">&quot;spinlock.h&quot;</font></strong></font>
<a name="line76" href="#line76">  76</a>     <strong>static</strong> <font color="#2040a0">spinlock_t</font> <font color="#2040a0">thread_lock</font>	<font color="4444FF">=</font> <font color="#2040a0">_SPINLOCK_INITIALIZER</font><font color="4444FF">;</font>
<a name="line77" href="#line77">  77</a>     <font color="#2040a0">spinlock_t</font> <font color="4444FF">*</font><font color="#2040a0">__malloc_lock</font>		<font color="4444FF">=</font> <font color="4444FF">&amp;</font><font color="#2040a0">thread_lock</font><font color="4444FF">;</font>
<a name="line78" href="#line78">  78</a> <font color="0000ff"><strong>#   define _MALLOC_LOCK()		if (__isthreaded) _SPINLOCK(&amp;thread_lock);</strong></font>
<a name="line79" href="#line79">  79</a> <font color="0000ff"><strong>#   define _MALLOC_UNLOCK()		if (__isthreaded) _SPINUNLOCK(&amp;thread_lock);</strong></font>
<a name="line80" href="#line80">  80</a> <font color="0000ff"><strong>#endif<font color="#444444"> /* __FreeBSD__ */</font></strong></font>
<a name="line81" href="#line81">  81</a> 
<a name="line82" href="#line82">  82</a> <font color="0000ff"><strong>#if defined(__sparc__) &amp;&amp; defined(sun)</strong></font>
<a name="line83" href="#line83">  83</a> <font color="0000ff"><strong>#   define malloc_pageshift		12U</strong></font>
<a name="line84" href="#line84">  84</a> <font color="0000ff"><strong>#   define malloc_minsize		16U</strong></font>
<a name="line85" href="#line85">  85</a> <font color="0000ff"><strong>#   define MAP_ANON			(0)</strong></font>
<a name="line86" href="#line86">  86</a>     <strong>static</strong> <strong>int</strong> <font color="#2040a0">fdzero</font><font color="4444FF">;</font>
<a name="line87" href="#line87">  87</a> <font color="0000ff"><strong>#   define MMAP_FD	fdzero</strong></font>
<a name="line88" href="#line88">  88</a> <font color="0000ff"><strong>#   define INIT_MMAP() \</strong></font>
<a name="line89" href="#line89">  89</a> 	<font color="4444FF"><strong>{</strong></font> <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">fdzero</font> <font color="4444FF">=</font> <font color="#2040a0">_open</font><font color="4444FF">(</font><font color="#2040a0">_PATH_DEVZERO</font>, <font color="#2040a0">O_RDWR</font>, <font color="#FF0000">0000</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">)</font> \
<a name="line90" href="#line90">  90</a> 	    <font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;open of /dev/zero&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font> <font color="4444FF"><strong>}</strong></font>
<a name="line91" href="#line91">  91</a> <font color="0000ff"><strong>#   define MADV_FREE			MADV_DONTNEED</strong></font>
<a name="line92" href="#line92">  92</a> <font color="0000ff"><strong>#endif<font color="#444444"> /* __sparc__ */</font></strong></font>
<a name="line93" href="#line93">  93</a> 
<a name="line94" href="#line94">  94</a> <font color="#444444">/* Insert your combination here... */</font>
<a name="line95" href="#line95">  95</a> <font color="0000ff"><strong>#if defined(__FOOCPU__) &amp;&amp; defined(__BAROS__)</strong></font>
<a name="line96" href="#line96">  96</a> <font color="0000ff"><strong>#   define malloc_pageshift		12U</strong></font>
<a name="line97" href="#line97">  97</a> <font color="0000ff"><strong>#   define malloc_minsize		16U</strong></font>
<a name="line98" href="#line98">  98</a> <font color="0000ff"><strong>#endif<font color="#444444"> /* __FOOCPU__ &amp;&amp; __BAROS__ */</font></strong></font>
<a name="line99" href="#line99">  99</a> 
<a name="line100" href="#line100"> 100</a> <font color="0000ff"><strong>#define uintptr_t unsigned int *</strong></font>
<a name="line101" href="#line101"> 101</a> 
<a name="line102" href="#line102"> 102</a> <font color="0000ff"><strong>#ifndef ZEROSIZEPTR</strong></font>
<a name="line103" href="#line103"> 103</a> <font color="0000ff"><strong>#define ZEROSIZEPTR	((void *)(uintptr_t)(1 &lt;&lt; (malloc_pageshift - 1)))</strong></font>
<a name="line104" href="#line104"> 104</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line105" href="#line105"> 105</a> 
<a name="line106" href="#line106"> 106</a> <font color="#444444">/*
<a name="line107" href="#line107"> 107</a>  * No user serviceable parts behind this point.
<a name="line108" href="#line108"> 108</a>  */</font>
<a name="line109" href="#line109"> 109</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;sys/types.h&gt;</font></strong></font>
<a name="line110" href="#line110"> 110</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;sys/mman.h&gt;</font></strong></font>
<a name="line111" href="#line111"> 111</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;errno.h&gt;</font></strong></font>
<a name="line112" href="#line112"> 112</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;fcntl.h&gt;</font></strong></font>
<a name="line113" href="#line113"> 113</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;paths.h&gt;</font></strong></font>
<a name="line114" href="#line114"> 114</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;stddef.h&gt;</font></strong></font>
<a name="line115" href="#line115"> 115</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;stdio.h&gt;</font></strong></font>
<a name="line116" href="#line116"> 116</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;stdlib.h&gt;</font></strong></font>
<a name="line117" href="#line117"> 117</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;string.h&gt;</font></strong></font>
<a name="line118" href="#line118"> 118</a> <font color="0000ff"><strong>#include <font color="#008000">&lt;unistd.h&gt;</font></strong></font>
<a name="line119" href="#line119"> 119</a> 
<a name="line120" href="#line120"> 120</a> <font color="#444444">/*
<a name="line121" href="#line121"> 121</a>  * This structure describes a page worth of chunks.
<a name="line122" href="#line122"> 122</a>  */</font>
<a name="line123" href="#line123"> 123</a> 
<a name="line124" href="#line124"> 124</a> <strong>struct</strong> <font color="#2040a0">pginfo</font> <font color="4444FF"><strong>{</strong></font>
<a name="line125" href="#line125"> 125</a>     <strong>struct</strong> <font color="#2040a0">pginfo</font>	<font color="4444FF">*</font><font color="#2040a0">next</font><font color="4444FF">;</font>	<font color="#444444">/* next on the free list */</font>
<a name="line126" href="#line126"> 126</a>     <strong>void</strong>		<font color="4444FF">*</font><font color="#2040a0">page</font><font color="4444FF">;</font>	<font color="#444444">/* Pointer to the page */</font>
<a name="line127" href="#line127"> 127</a>     <font color="#2040a0">u_short</font>		<font color="#2040a0">size</font><font color="4444FF">;</font>	<font color="#444444">/* size of this page's chunks */</font>
<a name="line128" href="#line128"> 128</a>     <font color="#2040a0">u_short</font>		<font color="#2040a0">shift</font><font color="4444FF">;</font>	<font color="#444444">/* How far to shift for this size chunks */</font>
<a name="line129" href="#line129"> 129</a>     <font color="#2040a0">u_short</font>		<font color="#2040a0">free</font><font color="4444FF">;</font>	<font color="#444444">/* How many free chunks */</font>
<a name="line130" href="#line130"> 130</a>     <font color="#2040a0">u_short</font>		<font color="#2040a0">total</font><font color="4444FF">;</font>	<font color="#444444">/* How many chunk */</font>
<a name="line131" href="#line131"> 131</a>     <font color="#2040a0">u_int</font>		<font color="#2040a0">bits</font><font color="4444FF">[</font><font color="#FF0000">1</font><font color="4444FF">]</font><font color="4444FF">;</font> <font color="#444444">/* Which chunks are free */</font>
<a name="line132" href="#line132"> 132</a> <font color="4444FF"><strong>}</strong></font><font color="4444FF">;</font>
<a name="line133" href="#line133"> 133</a> 
<a name="line134" href="#line134"> 134</a> <font color="#444444">/*
<a name="line135" href="#line135"> 135</a>  * This structure describes a number of free pages.
<a name="line136" href="#line136"> 136</a>  */</font>
<a name="line137" href="#line137"> 137</a> 
<a name="line138" href="#line138"> 138</a> <strong>struct</strong> <font color="#2040a0">pgfree</font> <font color="4444FF"><strong>{</strong></font>
<a name="line139" href="#line139"> 139</a>     <strong>struct</strong> <font color="#2040a0">pgfree</font>	<font color="4444FF">*</font><font color="#2040a0">next</font><font color="4444FF">;</font>	<font color="#444444">/* next run of free pages */</font>
<a name="line140" href="#line140"> 140</a>     <strong>struct</strong> <font color="#2040a0">pgfree</font>	<font color="4444FF">*</font><font color="#2040a0">prev</font><font color="4444FF">;</font>	<font color="#444444">/* prev run of free pages */</font>
<a name="line141" href="#line141"> 141</a>     <strong>void</strong>		<font color="4444FF">*</font><font color="#2040a0">page</font><font color="4444FF">;</font>	<font color="#444444">/* pointer to free pages */</font>
<a name="line142" href="#line142"> 142</a>     <strong>void</strong>		<font color="4444FF">*</font><font color="#2040a0">end</font><font color="4444FF">;</font>	<font color="#444444">/* pointer to end of free pages */</font>
<a name="line143" href="#line143"> 143</a>     <font color="#2040a0">size_t</font>		<font color="#2040a0">size</font><font color="4444FF">;</font>	<font color="#444444">/* number of bytes free */</font>
<a name="line144" href="#line144"> 144</a> <font color="4444FF"><strong>}</strong></font><font color="4444FF">;</font>
<a name="line145" href="#line145"> 145</a> 
<a name="line146" href="#line146"> 146</a> <font color="#444444">/*
<a name="line147" href="#line147"> 147</a>  * How many bits per u_int in the bitmap.
<a name="line148" href="#line148"> 148</a>  * Change only if not 8 bits/byte
<a name="line149" href="#line149"> 149</a>  */</font>
<a name="line150" href="#line150"> 150</a> <font color="0000ff"><strong>#define	MALLOC_BITS	(8*sizeof(u_int))</strong></font>
<a name="line151" href="#line151"> 151</a> 
<a name="line152" href="#line152"> 152</a> <font color="#444444">/*
<a name="line153" href="#line153"> 153</a>  * Magic values to put in the page_directory
<a name="line154" href="#line154"> 154</a>  */</font>
<a name="line155" href="#line155"> 155</a> <font color="0000ff"><strong>#define MALLOC_NOT_MINE	((struct pginfo*) 0)</strong></font>
<a name="line156" href="#line156"> 156</a> <font color="0000ff"><strong>#define MALLOC_FREE 	((struct pginfo*) 1)</strong></font>
<a name="line157" href="#line157"> 157</a> <font color="0000ff"><strong>#define MALLOC_FIRST	((struct pginfo*) 2)</strong></font>
<a name="line158" href="#line158"> 158</a> <font color="0000ff"><strong>#define MALLOC_FOLLOW	((struct pginfo*) 3)</strong></font>
<a name="line159" href="#line159"> 159</a> <font color="0000ff"><strong>#define MALLOC_MAGIC	((struct pginfo*) 4)</strong></font>
<a name="line160" href="#line160"> 160</a> 
<a name="line161" href="#line161"> 161</a> <font color="0000ff"><strong>#ifndef malloc_pageshift</strong></font>
<a name="line162" href="#line162"> 162</a> <font color="0000ff"><strong>#define malloc_pageshift		12U</strong></font>
<a name="line163" href="#line163"> 163</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line164" href="#line164"> 164</a> 
<a name="line165" href="#line165"> 165</a> <font color="0000ff"><strong>#ifndef malloc_minsize</strong></font>
<a name="line166" href="#line166"> 166</a> <font color="0000ff"><strong>#define malloc_minsize			16U</strong></font>
<a name="line167" href="#line167"> 167</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line168" href="#line168"> 168</a> 
<a name="line169" href="#line169"> 169</a> <font color="0000ff"><strong>#if !defined(malloc_pagesize)</strong></font>
<a name="line170" href="#line170"> 170</a> <font color="0000ff"><strong>#define malloc_pagesize			(1UL&lt;&lt;malloc_pageshift)</strong></font>
<a name="line171" href="#line171"> 171</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line172" href="#line172"> 172</a> 
<a name="line173" href="#line173"> 173</a> <font color="0000ff"><strong>#if ((1&lt;&lt;malloc_pageshift) != malloc_pagesize)</strong></font>
<a name="line174" href="#line174"> 174</a> <font color="0000ff"><strong>#error	<font color="#008000">&quot;(1&lt;&lt;malloc_pageshift) != malloc_pagesize&quot;</font></strong></font>
<a name="line175" href="#line175"> 175</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line176" href="#line176"> 176</a> 
<a name="line177" href="#line177"> 177</a> <font color="0000ff"><strong>#ifndef malloc_maxsize</strong></font>
<a name="line178" href="#line178"> 178</a> <font color="0000ff"><strong>#define malloc_maxsize			((malloc_pagesize)&gt;&gt;1)</strong></font>
<a name="line179" href="#line179"> 179</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line180" href="#line180"> 180</a> 
<a name="line181" href="#line181"> 181</a> <font color="#444444">/* A mask for the offset inside a page.  */</font>
<a name="line182" href="#line182"> 182</a> <font color="0000ff"><strong>#define malloc_pagemask	((malloc_pagesize)-1)</strong></font>
<a name="line183" href="#line183"> 183</a> 
<a name="line184" href="#line184"> 184</a> <font color="0000ff"><strong>#define pageround(foo) (((foo) + (malloc_pagemask))&amp;(~(malloc_pagemask)))</strong></font>
<a name="line185" href="#line185"> 185</a> <font color="0000ff"><strong>#define ptr2index(foo) (((u_long)(foo) &gt;&gt; malloc_pageshift)-malloc_origo)</strong></font>
<a name="line186" href="#line186"> 186</a> 
<a name="line187" href="#line187"> 187</a> <font color="0000ff"><strong>#ifndef _MALLOC_LOCK</strong></font>
<a name="line188" href="#line188"> 188</a> <font color="0000ff"><strong>#define _MALLOC_LOCK()</strong></font>
<a name="line189" href="#line189"> 189</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line190" href="#line190"> 190</a> 
<a name="line191" href="#line191"> 191</a> <font color="0000ff"><strong>#ifndef _MALLOC_UNLOCK</strong></font>
<a name="line192" href="#line192"> 192</a> <font color="0000ff"><strong>#define _MALLOC_UNLOCK()</strong></font>
<a name="line193" href="#line193"> 193</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line194" href="#line194"> 194</a> 
<a name="line195" href="#line195"> 195</a> <font color="0000ff"><strong>#ifndef MMAP_FD</strong></font>
<a name="line196" href="#line196"> 196</a> <font color="0000ff"><strong>#define MMAP_FD (-1)</strong></font>
<a name="line197" href="#line197"> 197</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line198" href="#line198"> 198</a> 
<a name="line199" href="#line199"> 199</a> <font color="0000ff"><strong>#ifndef INIT_MMAP</strong></font>
<a name="line200" href="#line200"> 200</a> <font color="0000ff"><strong>#define INIT_MMAP()</strong></font>
<a name="line201" href="#line201"> 201</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line202" href="#line202"> 202</a> 
<a name="line203" href="#line203"> 203</a> <font color="#444444">/* Number of free pages we cache */</font>
<a name="line204" href="#line204"> 204</a> <strong>static</strong> <strong>unsigned</strong> <font color="#2040a0">malloc_cache</font> <font color="4444FF">=</font> <font color="#FF0000">16</font><font color="4444FF">;</font>
<a name="line205" href="#line205"> 205</a> 
<a name="line206" href="#line206"> 206</a> <font color="#444444">/* The offset from pagenumber to index into the page directory */</font>
<a name="line207" href="#line207"> 207</a> <strong>static</strong> <font color="#2040a0">u_long</font> <font color="#2040a0">malloc_origo</font><font color="4444FF">;</font>
<a name="line208" href="#line208"> 208</a> 
<a name="line209" href="#line209"> 209</a> <font color="#444444">/* The last index in the page directory we care about */</font>
<a name="line210" href="#line210"> 210</a> <strong>static</strong> <font color="#2040a0">u_long</font> <font color="#2040a0">last_index</font><font color="4444FF">;</font>
<a name="line211" href="#line211"> 211</a> 
<a name="line212" href="#line212"> 212</a> <font color="#444444">/* Pointer to page directory. Allocated &quot;as if with&quot; malloc */</font>
<a name="line213" href="#line213"> 213</a> <strong>static</strong> <strong>struct</strong>	<font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="4444FF">*</font><font color="#2040a0">page_dir</font><font color="4444FF">;</font>
<a name="line214" href="#line214"> 214</a> 
<a name="line215" href="#line215"> 215</a> <font color="#444444">/* How many slots in the page directory */</font>
<a name="line216" href="#line216"> 216</a> <strong>static</strong> <strong>unsigned</strong>	<font color="#2040a0">malloc_ninfo</font><font color="4444FF">;</font>
<a name="line217" href="#line217"> 217</a> 
<a name="line218" href="#line218"> 218</a> <font color="#444444">/* Free pages line up here */</font>
<a name="line219" href="#line219"> 219</a> <strong>static</strong> <strong>struct</strong> <font color="#2040a0">pgfree</font> <font color="#2040a0">free_list</font><font color="4444FF">;</font>
<a name="line220" href="#line220"> 220</a> 
<a name="line221" href="#line221"> 221</a> <font color="#444444">/* Abort(), user doesn't handle problems.  */</font>
<a name="line222" href="#line222"> 222</a> <strong>static</strong> <strong>int</strong> <font color="#2040a0">malloc_abort</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line223" href="#line223"> 223</a> 
<a name="line224" href="#line224"> 224</a> <font color="#444444">/* Are we trying to die ?  */</font>
<a name="line225" href="#line225"> 225</a> <strong>static</strong> <strong>int</strong> <font color="#2040a0">suicide</font><font color="4444FF">;</font>
<a name="line226" href="#line226"> 226</a> 
<a name="line227" href="#line227"> 227</a> <font color="#444444">/* always realloc ?  */</font>
<a name="line228" href="#line228"> 228</a> <strong>static</strong> <strong>int</strong> <font color="#2040a0">malloc_realloc</font><font color="4444FF">;</font>
<a name="line229" href="#line229"> 229</a> 
<a name="line230" href="#line230"> 230</a> <font color="0000ff"><strong>#if defined(MADV_FREE)</strong></font>
<a name="line231" href="#line231"> 231</a> <font color="#444444">/* pass the kernel a hint on free pages ?  */</font>
<a name="line232" href="#line232"> 232</a> <strong>static</strong> <strong>int</strong> <font color="#2040a0">malloc_hint</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line233" href="#line233"> 233</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line234" href="#line234"> 234</a> 
<a name="line235" href="#line235"> 235</a> <font color="#444444">/* xmalloc behaviour ?  */</font>
<a name="line236" href="#line236"> 236</a> <strong>static</strong> <strong>int</strong> <font color="#2040a0">malloc_xmalloc</font><font color="4444FF">;</font>
<a name="line237" href="#line237"> 237</a> 
<a name="line238" href="#line238"> 238</a> <font color="#444444">/* sysv behaviour for malloc(0) ?  */</font>
<a name="line239" href="#line239"> 239</a> <strong>static</strong> <strong>int</strong> <font color="#2040a0">malloc_sysv</font><font color="4444FF">;</font>
<a name="line240" href="#line240"> 240</a> 
<a name="line241" href="#line241"> 241</a> <font color="#444444">/* zero fill ?  */</font>
<a name="line242" href="#line242"> 242</a> <strong>static</strong> <strong>int</strong> <font color="#2040a0">malloc_zero</font><font color="4444FF">;</font>
<a name="line243" href="#line243"> 243</a> 
<a name="line244" href="#line244"> 244</a> <font color="#444444">/* junk fill ?  */</font>
<a name="line245" href="#line245"> 245</a> <strong>static</strong> <strong>int</strong> <font color="#2040a0">malloc_junk</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line246" href="#line246"> 246</a> 
<a name="line247" href="#line247"> 247</a> <font color="0000ff"><strong>#ifdef HAS_UTRACE</strong></font>
<a name="line248" href="#line248"> 248</a> 
<a name="line249" href="#line249"> 249</a> <font color="#444444">/* utrace ?  */</font>
<a name="line250" href="#line250"> 250</a> <strong>static</strong> <strong>int</strong> <font color="#2040a0">malloc_utrace</font><font color="4444FF">;</font>
<a name="line251" href="#line251"> 251</a> 
<a name="line252" href="#line252"> 252</a> <strong>struct</strong> <font color="#2040a0">ut</font> <font color="4444FF"><strong>{</strong></font> <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">p</font><font color="4444FF">;</font> <font color="#2040a0">size_t</font> <font color="#2040a0">s</font><font color="4444FF">;</font> <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">r</font><font color="4444FF">;</font> <font color="4444FF"><strong>}</strong></font><font color="4444FF">;</font>
<a name="line253" href="#line253"> 253</a> 
<a name="line254" href="#line254"> 254</a> <strong>void</strong> <font color="#2040a0">utrace</font><font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">ut</font> <font color="4444FF">*</font>, <strong>int</strong><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line255" href="#line255"> 255</a> 
<a name="line256" href="#line256"> 256</a> <font color="0000ff"><strong>#define UTRACE(a, b, c) \</strong></font>
<a name="line257" href="#line257"> 257</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_utrace</font><font color="4444FF">)</font> \
<a name="line258" href="#line258"> 258</a> 		<font color="4444FF"><strong>{</strong></font><strong>struct</strong> <font color="#2040a0">ut</font> <font color="#2040a0">u</font><font color="4444FF">;</font> <font color="#2040a0">u</font>.<font color="#2040a0">p</font><font color="4444FF">=</font><font color="#2040a0">a</font><font color="4444FF">;</font> <font color="#2040a0">u</font>.<font color="#2040a0">s</font> <font color="4444FF">=</font> <font color="#2040a0">b</font><font color="4444FF">;</font> <font color="#2040a0">u</font>.<font color="#2040a0">r</font><font color="4444FF">=</font><font color="#2040a0">c</font><font color="4444FF">;</font> <font color="#2040a0">utrace</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">u</font>, <strong>sizeof</strong> <font color="#2040a0">u</font><font color="4444FF">)</font><font color="4444FF">;</font><font color="4444FF"><strong>}</strong></font>
<a name="line259" href="#line259"> 259</a> <font color="0000ff"><strong>#else<font color="#444444"> /* !HAS_UTRACE */</font></strong></font>
<a name="line260" href="#line260"> 260</a> <font color="0000ff"><strong>#define UTRACE(a,b,c)</strong></font>
<a name="line261" href="#line261"> 261</a> <font color="0000ff"><strong>#endif<font color="#444444"> /* HAS_UTRACE */</font></strong></font>
<a name="line262" href="#line262"> 262</a> 
<a name="line263" href="#line263"> 263</a> <font color="#444444">/* my last break. */</font>
<a name="line264" href="#line264"> 264</a> <strong>static</strong> <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">malloc_brk</font><font color="4444FF">;</font>
<a name="line265" href="#line265"> 265</a> 
<a name="line266" href="#line266"> 266</a> <font color="#444444">/* one location cache for free-list holders */</font>
<a name="line267" href="#line267"> 267</a> <strong>static</strong> <strong>struct</strong> <font color="#2040a0">pgfree</font> <font color="4444FF">*</font><font color="#2040a0">px</font><font color="4444FF">;</font>
<a name="line268" href="#line268"> 268</a> 
<a name="line269" href="#line269"> 269</a> <font color="#444444">/* compile-time options */</font>
<a name="line270" href="#line270"> 270</a> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">_malloc_options</font><font color="4444FF">;</font>
<a name="line271" href="#line271"> 271</a> 
<a name="line272" href="#line272"> 272</a> <font color="#444444">/* Name of the current public function */</font>
<a name="line273" href="#line273"> 273</a> <strong>static</strong> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">malloc_func</font><font color="4444FF">;</font>
<a name="line274" href="#line274"> 274</a> 
<a name="line275" href="#line275"> 275</a> <font color="#444444">/* Macro for mmap */</font>
<a name="line276" href="#line276"> 276</a> <font color="0000ff"><strong>#define MMAP(size) \</strong></font>
<a name="line277" href="#line277"> 277</a> 	<font color="#2040a0">mmap</font><font color="4444FF">(</font><font color="#2040a0">NULL</font>, <font color="4444FF">(</font><font color="#2040a0">size</font><font color="4444FF">)</font>, <font color="#2040a0">PROT_READ</font><font color="4444FF">|</font><font color="#2040a0">PROT_WRITE</font>, <font color="#2040a0">MAP_ANON</font><font color="4444FF">|</font><font color="#2040a0">MAP_PRIVATE</font>, \
<a name="line278" href="#line278"> 278</a> 	    <font color="#2040a0">MMAP_FD</font>, <font color="4444FF">(</font><font color="#2040a0">off_t</font><font color="4444FF">)</font><font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line279" href="#line279"> 279</a> 
<a name="line280" href="#line280"> 280</a> <font color="#444444">/*
<a name="line281" href="#line281"> 281</a>  * Necessary function declarations
<a name="line282" href="#line282"> 282</a>  */</font>
<a name="line283" href="#line283"> 283</a> <strong>static</strong> <strong>int</strong> <font color="#2040a0">extend_pgdir</font><font color="4444FF">(</font><font color="#2040a0">u_long</font> <font color="#2040a0">index</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line284" href="#line284"> 284</a> <strong>static</strong> <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">imalloc</font><font color="4444FF">(</font><font color="#2040a0">size_t</font> <font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line285" href="#line285"> 285</a> <strong>static</strong> <strong>void</strong> <font color="#2040a0">ifree</font><font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">ptr</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line286" href="#line286"> 286</a> <strong>static</strong> <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">irealloc</font><font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">ptr</font>, <font color="#2040a0">size_t</font> <font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line287" href="#line287"> 287</a> 
<a name="line288" href="#line288"> 288</a> <strong>static</strong> <strong>void</strong>
<a name="line289" href="#line289"> 289</a> <font color="#2040a0">wrtmessage</font><font color="4444FF">(</font><strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">p1</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">p2</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">p3</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">p4</font><font color="4444FF">)</font>
<a name="line290" href="#line290"> 290</a> <font color="4444FF"><strong>{</strong></font>
<a name="line291" href="#line291"> 291</a> 
<a name="line292" href="#line292"> 292</a>     <font color="#2040a0">write</font><font color="4444FF">(</font><font color="#2040a0">STDERR_FILENO</font>, <font color="#2040a0">p1</font>, <font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">p1</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line293" href="#line293"> 293</a>     <font color="#2040a0">write</font><font color="4444FF">(</font><font color="#2040a0">STDERR_FILENO</font>, <font color="#2040a0">p2</font>, <font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">p2</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line294" href="#line294"> 294</a>     <font color="#2040a0">write</font><font color="4444FF">(</font><font color="#2040a0">STDERR_FILENO</font>, <font color="#2040a0">p3</font>, <font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">p3</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line295" href="#line295"> 295</a>     <font color="#2040a0">write</font><font color="4444FF">(</font><font color="#2040a0">STDERR_FILENO</font>, <font color="#2040a0">p4</font>, <font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">p4</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line296" href="#line296"> 296</a> <font color="4444FF"><strong>}</strong></font>
<a name="line297" href="#line297"> 297</a> 
<a name="line298" href="#line298"> 298</a> <strong>void</strong> <font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">_malloc_message</font><font color="4444FF">)</font><font color="4444FF">(</font><strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">p1</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">p2</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">p3</font>,
<a name="line299" href="#line299"> 299</a> 	    <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">p4</font><font color="4444FF">)</font> <font color="4444FF">=</font> <font color="#2040a0">wrtmessage</font><font color="4444FF">;</font>
<a name="line300" href="#line300"> 300</a> 
<a name="line301" href="#line301"> 301</a> <strong>static</strong> <strong>void</strong>
<a name="line302" href="#line302"> 302</a> <font color="#2040a0">wrterror</font><font color="4444FF">(</font><strong>char</strong> <strong>const</strong> <font color="4444FF">*</font><font color="#2040a0">p</font><font color="4444FF">)</font>
<a name="line303" href="#line303"> 303</a> <font color="4444FF"><strong>{</strong></font>
<a name="line304" href="#line304"> 304</a> 
<a name="line305" href="#line305"> 305</a>     <font color="#2040a0">suicide</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line306" href="#line306"> 306</a>     <font color="#2040a0">_malloc_message</font><font color="4444FF">(</font><font color="#008000">&quot;aap&quot;</font>, <font color="#2040a0">malloc_func</font>, <font color="#008000">&quot; error: &quot;</font>, <font color="#2040a0">p</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line307" href="#line307"> 307</a>     <font color="#2040a0">abort</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line308" href="#line308"> 308</a> <font color="4444FF"><strong>}</strong></font>
<a name="line309" href="#line309"> 309</a> 
<a name="line310" href="#line310"> 310</a> <strong>static</strong> <strong>void</strong>
<a name="line311" href="#line311"> 311</a> <font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">p</font><font color="4444FF">)</font>
<a name="line312" href="#line312"> 312</a> <font color="4444FF"><strong>{</strong></font>
<a name="line313" href="#line313"> 313</a> 
<a name="line314" href="#line314"> 314</a>     <font color="#444444">/*
<a name="line315" href="#line315"> 315</a>      * Sensitive processes, somewhat arbitrarily defined here as setuid,
<a name="line316" href="#line316"> 316</a>      * setgid, root and wheel cannot afford to have malloc mistakes.
<a name="line317" href="#line317"> 317</a>      */</font>
<a name="line318" href="#line318"> 318</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_abort</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#444444">/* issetugid() || */</font> <font color="#2040a0">getuid</font><font color="4444FF">(</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">getgid</font><font color="4444FF">(</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">)</font>
<a name="line319" href="#line319"> 319</a> 	<font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#2040a0">p</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line320" href="#line320"> 320</a>     <font color="#2040a0">_malloc_message</font><font color="4444FF">(</font><font color="#008000">&quot;aap&quot;</font>, <font color="#2040a0">malloc_func</font>, <font color="#008000">&quot; warning: &quot;</font>, <font color="#2040a0">p</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line321" href="#line321"> 321</a> <font color="4444FF"><strong>}</strong></font>
<a name="line322" href="#line322"> 322</a> 
<a name="line323" href="#line323"> 323</a> <font color="#444444">/*
<a name="line324" href="#line324"> 324</a>  * Allocate a number of pages from the OS
<a name="line325" href="#line325"> 325</a>  */</font>
<a name="line326" href="#line326"> 326</a> <strong>static</strong> <strong>void</strong> <font color="4444FF">*</font>
<a name="line327" href="#line327"> 327</a> <font color="#2040a0">map_pages</font><font color="4444FF">(</font><font color="#2040a0">size_t</font> <font color="#2040a0">pages</font><font color="4444FF">)</font>
<a name="line328" href="#line328"> 328</a> <font color="4444FF"><strong>{</strong></font>
<a name="line329" href="#line329"> 329</a>     <font color="#2040a0">caddr_t</font> <font color="#2040a0">result</font>, <font color="#2040a0">tail</font><font color="4444FF">;</font>
<a name="line330" href="#line330"> 330</a> 
<a name="line331" href="#line331"> 331</a>     <font color="#2040a0">result</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">caddr_t</font><font color="4444FF">)</font><font color="#2040a0">pageround</font><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_long</font><font color="4444FF">)</font><font color="#2040a0">sbrk</font><font color="4444FF">(</font><font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line332" href="#line332"> 332</a>     <font color="#2040a0">tail</font> <font color="4444FF">=</font> <font color="#2040a0">result</font> <font color="4444FF">+</font> <font color="4444FF">(</font><font color="#2040a0">pages</font> <font color="4444FF">&lt;</font><font color="4444FF">&lt;</font> <font color="#2040a0">malloc_pageshift</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line333" href="#line333"> 333</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">tail</font> <font color="4444FF">&lt;</font> <font color="#2040a0">result</font><font color="4444FF">)</font>
<a name="line334" href="#line334"> 334</a> 	<strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line335" href="#line335"> 335</a> 
<a name="line336" href="#line336"> 336</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">brk</font><font color="4444FF">(</font><font color="#2040a0">tail</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line337" href="#line337"> 337</a> <font color="0000ff"><strong>#ifdef MALLOC_EXTRA_SANITY</strong></font>
<a name="line338" href="#line338"> 338</a> 	<font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;(ES): map_pages fails<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line339" href="#line339"> 339</a> <font color="0000ff"><strong>#endif<font color="#444444"> /* MALLOC_EXTRA_SANITY */</font></strong></font>
<a name="line340" href="#line340"> 340</a> 	<strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line341" href="#line341"> 341</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line342" href="#line342"> 342</a> 
<a name="line343" href="#line343"> 343</a>     <font color="#2040a0">last_index</font> <font color="4444FF">=</font> <font color="#2040a0">ptr2index</font><font color="4444FF">(</font><font color="#2040a0">tail</font><font color="4444FF">)</font> <font color="4444FF">-</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line344" href="#line344"> 344</a>     <font color="#2040a0">malloc_brk</font> <font color="4444FF">=</font> <font color="#2040a0">tail</font><font color="4444FF">;</font>
<a name="line345" href="#line345"> 345</a> 
<a name="line346" href="#line346"> 346</a>     <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">last_index</font><font color="4444FF">+</font><font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF">&gt;</font><font color="4444FF">=</font> <font color="#2040a0">malloc_ninfo</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="4444FF">!</font><font color="#2040a0">extend_pgdir</font><font color="4444FF">(</font><font color="#2040a0">last_index</font><font color="4444FF">)</font><font color="4444FF">)</font>
<a name="line347" href="#line347"> 347</a> 	<strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line348" href="#line348"> 348</a> 
<a name="line349" href="#line349"> 349</a>     <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">result</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line350" href="#line350"> 350</a> <font color="4444FF"><strong>}</strong></font>
<a name="line351" href="#line351"> 351</a> 
<a name="line352" href="#line352"> 352</a> <font color="#444444">/*
<a name="line353" href="#line353"> 353</a>  * Extend page directory
<a name="line354" href="#line354"> 354</a>  */</font>
<a name="line355" href="#line355"> 355</a> <strong>static</strong> <strong>int</strong>
<a name="line356" href="#line356"> 356</a> <font color="#2040a0">extend_pgdir</font><font color="4444FF">(</font><font color="#2040a0">u_long</font> <font color="#2040a0">index</font><font color="4444FF">)</font>
<a name="line357" href="#line357"> 357</a> <font color="4444FF"><strong>{</strong></font>
<a name="line358" href="#line358"> 358</a>     <strong>struct</strong>  <font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="4444FF">*</font><font color="#2040a0">new</font>, <font color="4444FF">*</font><font color="4444FF">*</font><font color="#2040a0">old</font><font color="4444FF">;</font>
<a name="line359" href="#line359"> 359</a>     <font color="#2040a0">u_long</font> <font color="#2040a0">i</font>, <font color="#2040a0">oldlen</font><font color="4444FF">;</font>
<a name="line360" href="#line360"> 360</a> 
<a name="line361" href="#line361"> 361</a>     <font color="#444444">/* Make it this many pages */</font>
<a name="line362" href="#line362"> 362</a>     <font color="#2040a0">i</font> <font color="4444FF">=</font> <font color="#2040a0">index</font> <font color="4444FF">*</font> <strong>sizeof</strong> <font color="4444FF">*</font><font color="#2040a0">page_dir</font><font color="4444FF">;</font>
<a name="line363" href="#line363"> 363</a>     <font color="#2040a0">i</font> /<font color="4444FF">=</font> <font color="#2040a0">malloc_pagesize</font><font color="4444FF">;</font>
<a name="line364" href="#line364"> 364</a>     <font color="#2040a0">i</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#FF0000">2</font><font color="4444FF">;</font>
<a name="line365" href="#line365"> 365</a> 
<a name="line366" href="#line366"> 366</a>     <font color="#444444">/* remember the old mapping size */</font>
<a name="line367" href="#line367"> 367</a>     <font color="#2040a0">oldlen</font> <font color="4444FF">=</font> <font color="#2040a0">malloc_ninfo</font> <font color="4444FF">*</font> <strong>sizeof</strong> <font color="4444FF">*</font><font color="#2040a0">page_dir</font><font color="4444FF">;</font>
<a name="line368" href="#line368"> 368</a> 
<a name="line369" href="#line369"> 369</a>     <font color="#444444">/*
<a name="line370" href="#line370"> 370</a>      * NOTE: we allocate new pages and copy the directory rather than tempt
<a name="line371" href="#line371"> 371</a>      * fate by trying to &quot;grow&quot; the region.. There is nothing to prevent
<a name="line372" href="#line372"> 372</a>      * us from accidently re-mapping space that's been allocated by our caller
<a name="line373" href="#line373"> 373</a>      * via dlopen() or other mmap().
<a name="line374" href="#line374"> 374</a>      *
<a name="line375" href="#line375"> 375</a>      * The copy problem is not too bad, as there is 4K of page index per
<a name="line376" href="#line376"> 376</a>      * 4MB of malloc arena.
<a name="line377" href="#line377"> 377</a>      *
<a name="line378" href="#line378"> 378</a>      * We can totally avoid the copy if we open a file descriptor to associate
<a name="line379" href="#line379"> 379</a>      * the anon mappings with.  Then, when we remap the pages at the new
<a name="line380" href="#line380"> 380</a>      * address, the old pages will be &quot;magically&quot; remapped..  But this means
<a name="line381" href="#line381"> 381</a>      * keeping open a &quot;secret&quot; file descriptor.....
<a name="line382" href="#line382"> 382</a>      */</font>
<a name="line383" href="#line383"> 383</a> 
<a name="line384" href="#line384"> 384</a>     <font color="#444444">/* Get new pages */</font>
<a name="line385" href="#line385"> 385</a>     <font color="#2040a0">new</font> <font color="4444FF">=</font> <font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">pginfo</font><font color="4444FF">*</font><font color="4444FF">*</font><font color="4444FF">)</font> <font color="#2040a0">MMAP</font><font color="4444FF">(</font><font color="#2040a0">i</font> <font color="4444FF">*</font> <font color="#2040a0">malloc_pagesize</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line386" href="#line386"> 386</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">new</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">MAP_FAILED</font><font color="4444FF">)</font>
<a name="line387" href="#line387"> 387</a> 	<strong>return</strong> <font color="4444FF">(</font><font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line388" href="#line388"> 388</a> 
<a name="line389" href="#line389"> 389</a>     <font color="#444444">/* Copy the old stuff */</font>
<a name="line390" href="#line390"> 390</a>     <font color="#2040a0">memcpy</font><font color="4444FF">(</font><font color="#2040a0">new</font>, <font color="#2040a0">page_dir</font>,
<a name="line391" href="#line391"> 391</a> 	    <font color="#2040a0">malloc_ninfo</font> <font color="4444FF">*</font> <strong>sizeof</strong> <font color="4444FF">*</font><font color="#2040a0">page_dir</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line392" href="#line392"> 392</a> 
<a name="line393" href="#line393"> 393</a>     <font color="#444444">/* register the new size */</font>
<a name="line394" href="#line394"> 394</a>     <font color="#2040a0">malloc_ninfo</font> <font color="4444FF">=</font> <font color="#2040a0">i</font> <font color="4444FF">*</font> <font color="#2040a0">malloc_pagesize</font> / <strong>sizeof</strong> <font color="4444FF">*</font><font color="#2040a0">page_dir</font><font color="4444FF">;</font>
<a name="line395" href="#line395"> 395</a> 
<a name="line396" href="#line396"> 396</a>     <font color="#444444">/* swap the pointers */</font>
<a name="line397" href="#line397"> 397</a>     <font color="#2040a0">old</font> <font color="4444FF">=</font> <font color="#2040a0">page_dir</font><font color="4444FF">;</font>
<a name="line398" href="#line398"> 398</a>     <font color="#2040a0">page_dir</font> <font color="4444FF">=</font> <font color="#2040a0">new</font><font color="4444FF">;</font>
<a name="line399" href="#line399"> 399</a> 
<a name="line400" href="#line400"> 400</a>     <font color="#444444">/* Now free the old stuff */</font>
<a name="line401" href="#line401"> 401</a>     <font color="#2040a0">munmap</font><font color="4444FF">(</font><font color="#2040a0">old</font>, <font color="#2040a0">oldlen</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line402" href="#line402"> 402</a>     <strong>return</strong> <font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line403" href="#line403"> 403</a> <font color="4444FF"><strong>}</strong></font>
<a name="line404" href="#line404"> 404</a> 
<a name="line405" href="#line405"> 405</a> <font color="#444444">/*
<a name="line406" href="#line406"> 406</a>  * Initialize the world
<a name="line407" href="#line407"> 407</a>  */</font>
<a name="line408" href="#line408"> 408</a> <strong>static</strong> <strong>void</strong>
<a name="line409" href="#line409"> 409</a> <font color="#2040a0">malloc_init</font><font color="4444FF">(</font><strong>void</strong><font color="4444FF">)</font>
<a name="line410" href="#line410"> 410</a> <font color="4444FF"><strong>{</strong></font>
<a name="line411" href="#line411"> 411</a>     <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">p</font><font color="4444FF">;</font>
<a name="line412" href="#line412"> 412</a>     <strong>char</strong> <font color="#2040a0">b</font><font color="4444FF">[</font><font color="#FF0000">64</font><font color="4444FF">]</font><font color="4444FF">;</font>
<a name="line413" href="#line413"> 413</a>     <strong>int</strong> <font color="#2040a0">i</font>, <font color="#2040a0">j</font><font color="4444FF">;</font>
<a name="line414" href="#line414"> 414</a>     <strong>int</strong> <font color="#2040a0">save_errno</font> <font color="4444FF">=</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
<a name="line415" href="#line415"> 415</a> 
<a name="line416" href="#line416"> 416</a>     <font color="#2040a0">INIT_MMAP</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line417" href="#line417"> 417</a> 
<a name="line418" href="#line418"> 418</a> <font color="0000ff"><strong>#ifdef MALLOC_EXTRA_SANITY</strong></font>
<a name="line419" href="#line419"> 419</a>     <font color="#2040a0">malloc_junk</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line420" href="#line420"> 420</a> <font color="0000ff"><strong>#endif<font color="#444444"> /* MALLOC_EXTRA_SANITY */</font></strong></font>
<a name="line421" href="#line421"> 421</a> 
<a name="line422" href="#line422"> 422</a>     <strong>for</strong> <font color="4444FF">(</font><font color="#2040a0">i</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <font color="#2040a0">i</font> <font color="4444FF">&lt;</font> <font color="#FF0000">3</font><font color="4444FF">;</font> <font color="#2040a0">i</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line423" href="#line423"> 423</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">i</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line424" href="#line424"> 424</a> 	    <font color="#2040a0">j</font> <font color="4444FF">=</font> <font color="#2040a0">readlink</font><font color="4444FF">(</font><font color="#008000">&quot;/etc/malloc.conf&quot;</font>, <font color="#2040a0">b</font>, <strong>sizeof</strong> <font color="#2040a0">b</font> <font color="4444FF">-</font> <font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line425" href="#line425"> 425</a> 	    <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">j</font> <font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">)</font>
<a name="line426" href="#line426"> 426</a> 		<strong>continue</strong><font color="4444FF">;</font>
<a name="line427" href="#line427"> 427</a> 	    <font color="#2040a0">b</font><font color="4444FF">[</font><font color="#2040a0">j</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#008000">'<font color="#77dd77">\0</font>'</font><font color="4444FF">;</font>
<a name="line428" href="#line428"> 428</a> 	    <font color="#2040a0">p</font> <font color="4444FF">=</font> <font color="#2040a0">b</font><font color="4444FF">;</font>
<a name="line429" href="#line429"> 429</a> 	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">i</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">1</font> <font color="#444444">/* &amp;&amp; issetugid() == 0 */</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line430" href="#line430"> 430</a> 	    <font color="#2040a0">p</font> <font color="4444FF">=</font> <font color="#2040a0">getenv</font><font color="4444FF">(</font><font color="#008000">&quot;MALLOC_OPTIONS&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line431" href="#line431"> 431</a> 	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">i</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line432" href="#line432"> 432</a> 	    <strong>continue</strong><font color="4444FF">;</font>
<a name="line433" href="#line433"> 433</a> 	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
<a name="line434" href="#line434"> 434</a> 	    <font color="#2040a0">p</font> <font color="4444FF">=</font> <font color="#2040a0">_malloc_options</font><font color="4444FF">;</font>
<a name="line435" href="#line435"> 435</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line436" href="#line436"> 436</a> 	<strong>for</strong> <font color="4444FF">(</font><font color="4444FF">;</font> <font color="#2040a0">p</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="4444FF">*</font><font color="#2040a0">p</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#008000">'<font color="#77dd77">\0</font>'</font><font color="4444FF">;</font> <font color="#2040a0">p</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line437" href="#line437"> 437</a> 	    <strong>switch</strong> <font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">p</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line438" href="#line438"> 438</a> 		<strong>case</strong> <font color="#008000">'&gt;'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_cache</font>   <font color="4444FF">&lt;</font><font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line439" href="#line439"> 439</a> 		<strong>case</strong> <font color="#008000">'&lt;'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_cache</font>   <font color="4444FF">&gt;</font><font color="4444FF">&gt;</font><font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line440" href="#line440"> 440</a> 		<strong>case</strong> <font color="#008000">'a'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_abort</font>   <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line441" href="#line441"> 441</a> 		<strong>case</strong> <font color="#008000">'A'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_abort</font>   <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line442" href="#line442"> 442</a> <font color="0000ff"><strong>#if defined(MADV_FREE)</strong></font>
<a name="line443" href="#line443"> 443</a> 		<strong>case</strong> <font color="#008000">'h'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_hint</font>    <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line444" href="#line444"> 444</a> 		<strong>case</strong> <font color="#008000">'H'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_hint</font>    <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line445" href="#line445"> 445</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line446" href="#line446"> 446</a> 		<strong>case</strong> <font color="#008000">'r'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_realloc</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line447" href="#line447"> 447</a> 		<strong>case</strong> <font color="#008000">'R'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_realloc</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line448" href="#line448"> 448</a> 		<strong>case</strong> <font color="#008000">'j'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_junk</font>    <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line449" href="#line449"> 449</a> 		<strong>case</strong> <font color="#008000">'J'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_junk</font>    <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line450" href="#line450"> 450</a> <font color="0000ff"><strong>#ifdef HAS_UTRACE</strong></font>
<a name="line451" href="#line451"> 451</a> 		<strong>case</strong> <font color="#008000">'u'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_utrace</font>  <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line452" href="#line452"> 452</a> 		<strong>case</strong> <font color="#008000">'U'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_utrace</font>  <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line453" href="#line453"> 453</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line454" href="#line454"> 454</a> 		<strong>case</strong> <font color="#008000">'v'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_sysv</font>    <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line455" href="#line455"> 455</a> 		<strong>case</strong> <font color="#008000">'V'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_sysv</font>    <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line456" href="#line456"> 456</a> 		<strong>case</strong> <font color="#008000">'x'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_xmalloc</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line457" href="#line457"> 457</a> 		<strong>case</strong> <font color="#008000">'X'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_xmalloc</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line458" href="#line458"> 458</a> 		<strong>case</strong> <font color="#008000">'z'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_zero</font>    <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line459" href="#line459"> 459</a> 		<strong>case</strong> <font color="#008000">'Z'</font><font color="4444FF">:</font> <font color="#2040a0">malloc_zero</font>    <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <strong>break</strong><font color="4444FF">;</font>
<a name="line460" href="#line460"> 460</a> 		<strong>default</strong><font color="4444FF">:</font>
<a name="line461" href="#line461"> 461</a> 		    <font color="#2040a0">_malloc_message</font><font color="4444FF">(</font><font color="#008000">&quot;aap&quot;</font>, <font color="#2040a0">malloc_func</font>,
<a name="line462" href="#line462"> 462</a> 			 <font color="#008000">&quot; warning: &quot;</font>, <font color="#008000">&quot;unknown char in MALLOC_OPTIONS<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line463" href="#line463"> 463</a> 		    <strong>break</strong><font color="4444FF">;</font>
<a name="line464" href="#line464"> 464</a> 	    <font color="4444FF"><strong>}</strong></font>
<a name="line465" href="#line465"> 465</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line466" href="#line466"> 466</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line467" href="#line467"> 467</a> 
<a name="line468" href="#line468"> 468</a> 
<a name="line469" href="#line469"> 469</a>     <font color="#2040a0">UTRACE</font><font color="4444FF">(</font><font color="#FF0000">0</font>, <font color="#FF0000">0</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line470" href="#line470"> 470</a> 
<a name="line471" href="#line471"> 471</a>     <font color="#444444">/*
<a name="line472" href="#line472"> 472</a>      * We want junk in the entire allocation, and zero only in the part
<a name="line473" href="#line473"> 473</a>      * the user asked for.
<a name="line474" href="#line474"> 474</a>      */</font>
<a name="line475" href="#line475"> 475</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_zero</font><font color="4444FF">)</font>
<a name="line476" href="#line476"> 476</a> 	<font color="#2040a0">malloc_junk</font><font color="4444FF">=</font><font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line477" href="#line477"> 477</a> 
<a name="line478" href="#line478"> 478</a>     <font color="#444444">/* Allocate one page for the page directory */</font>
<a name="line479" href="#line479"> 479</a>     <font color="#2040a0">page_dir</font> <font color="4444FF">=</font> <font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="4444FF">*</font><font color="4444FF">)</font> <font color="#2040a0">MMAP</font><font color="4444FF">(</font><font color="#2040a0">malloc_pagesize</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line480" href="#line480"> 480</a> 
<a name="line481" href="#line481"> 481</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">page_dir</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">MAP_FAILED</font><font color="4444FF">)</font>
<a name="line482" href="#line482"> 482</a> 	<font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;mmap(2) failed, check limits<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line483" href="#line483"> 483</a> 
<a name="line484" href="#line484"> 484</a>     <font color="#444444">/*
<a name="line485" href="#line485"> 485</a>      * We need a maximum of malloc_pageshift buckets, steal these from the
<a name="line486" href="#line486"> 486</a>      * front of the page_directory;
<a name="line487" href="#line487"> 487</a>      */</font>
<a name="line488" href="#line488"> 488</a>     <font color="#2040a0">malloc_origo</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_long</font><font color="4444FF">)</font><font color="#2040a0">pageround</font><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_long</font><font color="4444FF">)</font><font color="#2040a0">sbrk</font><font color="4444FF">(</font><font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">&gt;</font><font color="4444FF">&gt;</font> <font color="#2040a0">malloc_pageshift</font><font color="4444FF">;</font>
<a name="line489" href="#line489"> 489</a>     <font color="#2040a0">malloc_origo</font> <font color="4444FF">-</font><font color="4444FF">=</font> <font color="#2040a0">malloc_pageshift</font><font color="4444FF">;</font>
<a name="line490" href="#line490"> 490</a> 
<a name="line491" href="#line491"> 491</a>     <font color="#2040a0">malloc_ninfo</font> <font color="4444FF">=</font> <font color="#2040a0">malloc_pagesize</font> / <strong>sizeof</strong> <font color="4444FF">*</font><font color="#2040a0">page_dir</font><font color="4444FF">;</font>
<a name="line492" href="#line492"> 492</a> 
<a name="line493" href="#line493"> 493</a>     <font color="#444444">/* Recalculate the cache size in bytes, and make sure it's nonzero */</font>
<a name="line494" href="#line494"> 494</a> 
<a name="line495" href="#line495"> 495</a>     <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">malloc_cache</font><font color="4444FF">)</font>
<a name="line496" href="#line496"> 496</a> 	<font color="#2040a0">malloc_cache</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">;</font>
<a name="line497" href="#line497"> 497</a> 
<a name="line498" href="#line498"> 498</a>     <font color="#2040a0">malloc_cache</font> <font color="4444FF">&lt;</font><font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#2040a0">malloc_pageshift</font><font color="4444FF">;</font>
<a name="line499" href="#line499"> 499</a> 
<a name="line500" href="#line500"> 500</a>     <font color="#444444">/*
<a name="line501" href="#line501"> 501</a>      * This is a nice hack from Kaleb Keithly (kaleb@x.org).
<a name="line502" href="#line502"> 502</a>      * We can sbrk(2) further back when we keep this on a low address.
<a name="line503" href="#line503"> 503</a>      */</font>
<a name="line504" href="#line504"> 504</a>     <font color="#2040a0">px</font> <font color="4444FF">=</font> <font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">pgfree</font> <font color="4444FF">*</font><font color="4444FF">)</font> <font color="#2040a0">imalloc</font> <font color="4444FF">(</font><strong>sizeof</strong> <font color="4444FF">*</font><font color="#2040a0">px</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line505" href="#line505"> 505</a>     <font color="#2040a0">errno</font> <font color="4444FF">=</font> <font color="#2040a0">save_errno</font><font color="4444FF">;</font>
<a name="line506" href="#line506"> 506</a> <font color="4444FF"><strong>}</strong></font>
<a name="line507" href="#line507"> 507</a> 
<a name="line508" href="#line508"> 508</a> <font color="#444444">/*
<a name="line509" href="#line509"> 509</a>  * Allocate a number of complete pages
<a name="line510" href="#line510"> 510</a>  */</font>
<a name="line511" href="#line511"> 511</a> <strong>static</strong> <strong>void</strong> <font color="4444FF">*</font>
<a name="line512" href="#line512"> 512</a> <font color="#2040a0">malloc_pages</font><font color="4444FF">(</font><font color="#2040a0">size_t</font> <font color="#2040a0">size</font><font color="4444FF">)</font>
<a name="line513" href="#line513"> 513</a> <font color="4444FF"><strong>{</strong></font>
<a name="line514" href="#line514"> 514</a>     <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">p</font>, <font color="4444FF">*</font><font color="#2040a0">delay_free</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line515" href="#line515"> 515</a>     <font color="#2040a0">size_t</font> <font color="#2040a0">i</font><font color="4444FF">;</font>
<a name="line516" href="#line516"> 516</a>     <strong>struct</strong> <font color="#2040a0">pgfree</font> <font color="4444FF">*</font><font color="#2040a0">pf</font><font color="4444FF">;</font>
<a name="line517" href="#line517"> 517</a>     <font color="#2040a0">u_long</font> <font color="#2040a0">index</font><font color="4444FF">;</font>
<a name="line518" href="#line518"> 518</a> 
<a name="line519" href="#line519"> 519</a>     <font color="#2040a0">size</font> <font color="4444FF">=</font> <font color="#2040a0">pageround</font><font color="4444FF">(</font><font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line520" href="#line520"> 520</a> 
<a name="line521" href="#line521"> 521</a>     <font color="#2040a0">p</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line522" href="#line522"> 522</a> 
<a name="line523" href="#line523"> 523</a>     <font color="#444444">/* Look for free pages before asking for more */</font>
<a name="line524" href="#line524"> 524</a>     <strong>for</strong><font color="4444FF">(</font><font color="#2040a0">pf</font> <font color="4444FF">=</font> <font color="#2040a0">free_list</font>.<font color="#2040a0">next</font><font color="4444FF">;</font> <font color="#2040a0">pf</font><font color="4444FF">;</font> <font color="#2040a0">pf</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line525" href="#line525"> 525</a> 
<a name="line526" href="#line526"> 526</a> <font color="0000ff"><strong>#ifdef MALLOC_EXTRA_SANITY</strong></font>
<a name="line527" href="#line527"> 527</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">&amp;</font> <font color="#2040a0">malloc_pagemask</font><font color="4444FF">)</font>
<a name="line528" href="#line528"> 528</a> 	    <font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;(ES): junk length entry on free_list<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line529" href="#line529"> 529</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font><font color="4444FF">)</font>
<a name="line530" href="#line530"> 530</a> 	    <font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;(ES): zero length entry on free_list<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line531" href="#line531"> 531</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font><font color="4444FF">)</font>
<a name="line532" href="#line532"> 532</a> 	    <font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;(ES): zero entry on free_list<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line533" href="#line533"> 533</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">&gt;</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font><font color="4444FF">)</font>
<a name="line534" href="#line534"> 534</a> 	    <font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;(ES): sick entry on free_list<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line535" href="#line535"> 535</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><strong>void</strong><font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">&gt;</font><font color="4444FF">=</font> <font color="4444FF">(</font><strong>void</strong><font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">sbrk</font><font color="4444FF">(</font><font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">)</font>
<a name="line536" href="#line536"> 536</a> 	    <font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;(ES): entry on free_list past brk<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line537" href="#line537"> 537</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">ptr2index</font><font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font><font color="4444FF">)</font><font color="4444FF">]</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_FREE</font><font color="4444FF">)</font>
<a name="line538" href="#line538"> 538</a> 	    <font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;(ES): non-free first page on free-list<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line539" href="#line539"> 539</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">ptr2index</font><font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">]</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_FREE</font><font color="4444FF">)</font>
<a name="line540" href="#line540"> 540</a> 	    <font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;(ES): non-free last page on free-list<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line541" href="#line541"> 541</a> <font color="0000ff"><strong>#endif<font color="#444444"> /* MALLOC_EXTRA_SANITY */</font></strong></font>
<a name="line542" href="#line542"> 542</a> 
<a name="line543" href="#line543"> 543</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">&lt;</font> <font color="#2040a0">size</font><font color="4444FF">)</font>
<a name="line544" href="#line544"> 544</a> 	    <strong>continue</strong><font color="4444FF">;</font>
<a name="line545" href="#line545"> 545</a> 
<a name="line546" href="#line546"> 546</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">size</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line547" href="#line547"> 547</a> 	    <font color="#2040a0">p</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font><font color="4444FF">;</font>
<a name="line548" href="#line548"> 548</a> 	    <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line549" href="#line549"> 549</a> 		    <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font><font color="4444FF">;</font>
<a name="line550" href="#line550"> 550</a> 	    <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
<a name="line551" href="#line551"> 551</a> 	    <font color="#2040a0">delay_free</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">;</font>
<a name="line552" href="#line552"> 552</a> 	    <strong>break</strong><font color="4444FF">;</font>
<a name="line553" href="#line553"> 553</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line554" href="#line554"> 554</a> 
<a name="line555" href="#line555"> 555</a> 	<font color="#2040a0">p</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font><font color="4444FF">;</font>
<a name="line556" href="#line556"> 556</a> 	<font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">=</font> <font color="4444FF">(</font><strong>char</strong> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">+</font> <font color="#2040a0">size</font><font color="4444FF">;</font>
<a name="line557" href="#line557"> 557</a> 	<font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">-</font><font color="4444FF">=</font> <font color="#2040a0">size</font><font color="4444FF">;</font>
<a name="line558" href="#line558"> 558</a> 	<strong>break</strong><font color="4444FF">;</font>
<a name="line559" href="#line559"> 559</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line560" href="#line560"> 560</a> 
<a name="line561" href="#line561"> 561</a> <font color="0000ff"><strong>#ifdef MALLOC_EXTRA_SANITY</strong></font>
<a name="line562" href="#line562"> 562</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">p</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">ptr2index</font><font color="4444FF">(</font><font color="#2040a0">p</font><font color="4444FF">)</font><font color="4444FF">]</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_FREE</font><font color="4444FF">)</font>
<a name="line563" href="#line563"> 563</a> 	<font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;(ES): allocated non-free page on free-list<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line564" href="#line564"> 564</a> <font color="0000ff"><strong>#endif<font color="#444444"> /* MALLOC_EXTRA_SANITY */</font></strong></font>
<a name="line565" href="#line565"> 565</a> 
<a name="line566" href="#line566"> 566</a>     <font color="#2040a0">size</font> <font color="4444FF">&gt;</font><font color="4444FF">&gt;</font><font color="4444FF">=</font> <font color="#2040a0">malloc_pageshift</font><font color="4444FF">;</font>
<a name="line567" href="#line567"> 567</a> 
<a name="line568" href="#line568"> 568</a>     <font color="#444444">/* Map new pages */</font>
<a name="line569" href="#line569"> 569</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">p</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line570" href="#line570"> 570</a> 	<font color="#2040a0">p</font> <font color="4444FF">=</font> <font color="#2040a0">map_pages</font><font color="4444FF">(</font><font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line571" href="#line571"> 571</a> 
<a name="line572" href="#line572"> 572</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">p</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line573" href="#line573"> 573</a> 
<a name="line574" href="#line574"> 574</a> 	<font color="#2040a0">index</font> <font color="4444FF">=</font> <font color="#2040a0">ptr2index</font><font color="4444FF">(</font><font color="#2040a0">p</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line575" href="#line575"> 575</a> 	<font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">index</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">MALLOC_FIRST</font><font color="4444FF">;</font>
<a name="line576" href="#line576"> 576</a> 	<strong>for</strong> <font color="4444FF">(</font><font color="#2040a0">i</font><font color="4444FF">=</font><font color="#FF0000">1</font><font color="4444FF">;</font><font color="#2040a0">i</font><font color="4444FF">&lt;</font><font color="#2040a0">size</font><font color="4444FF">;</font><font color="#2040a0">i</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font>
<a name="line577" href="#line577"> 577</a> 	    <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">index</font><font color="4444FF">+</font><font color="#2040a0">i</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">MALLOC_FOLLOW</font><font color="4444FF">;</font>
<a name="line578" href="#line578"> 578</a> 
<a name="line579" href="#line579"> 579</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_junk</font><font color="4444FF">)</font>
<a name="line580" href="#line580"> 580</a> 	    <font color="#2040a0">memset</font><font color="4444FF">(</font><font color="#2040a0">p</font>, <font color="#2040a0">SOME_JUNK</font>, <font color="#2040a0">size</font> <font color="4444FF">&lt;</font><font color="4444FF">&lt;</font> <font color="#2040a0">malloc_pageshift</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line581" href="#line581"> 581</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line582" href="#line582"> 582</a> 
<a name="line583" href="#line583"> 583</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">delay_free</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line584" href="#line584"> 584</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">px</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line585" href="#line585"> 585</a> 	    <font color="#2040a0">px</font> <font color="4444FF">=</font> <font color="#2040a0">delay_free</font><font color="4444FF">;</font>
<a name="line586" href="#line586"> 586</a> 	<strong>else</strong>
<a name="line587" href="#line587"> 587</a> 	    <font color="#2040a0">ifree</font><font color="4444FF">(</font><font color="#2040a0">delay_free</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line588" href="#line588"> 588</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line589" href="#line589"> 589</a> 
<a name="line590" href="#line590"> 590</a>     <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">p</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line591" href="#line591"> 591</a> <font color="4444FF"><strong>}</strong></font>
<a name="line592" href="#line592"> 592</a> 
<a name="line593" href="#line593"> 593</a> <font color="#444444">/*
<a name="line594" href="#line594"> 594</a>  * Allocate a page of fragments
<a name="line595" href="#line595"> 595</a>  */</font>
<a name="line596" href="#line596"> 596</a> 
<a name="line597" href="#line597"> 597</a> <strong>static</strong> <font color="#2040a0">__inline__</font> <strong>int</strong>
<a name="line598" href="#line598"> 598</a> <font color="#2040a0">malloc_make_chunks</font><font color="4444FF">(</font><strong>int</strong> <font color="#2040a0">bits</font><font color="4444FF">)</font>
<a name="line599" href="#line599"> 599</a> <font color="4444FF"><strong>{</strong></font>
<a name="line600" href="#line600"> 600</a>     <strong>struct</strong>  <font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="#2040a0">bp</font><font color="4444FF">;</font>
<a name="line601" href="#line601"> 601</a>     <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">pp</font><font color="4444FF">;</font>
<a name="line602" href="#line602"> 602</a>     <strong>int</strong> <font color="#2040a0">i</font>, <font color="#2040a0">k</font>, <font color="#2040a0">l</font><font color="4444FF">;</font>
<a name="line603" href="#line603"> 603</a> 
<a name="line604" href="#line604"> 604</a>     <font color="#444444">/* Allocate a new bucket */</font>
<a name="line605" href="#line605"> 605</a>     <font color="#2040a0">pp</font> <font color="4444FF">=</font> <font color="#2040a0">malloc_pages</font><font color="4444FF">(</font><font color="#2040a0">malloc_pagesize</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line606" href="#line606"> 606</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pp</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line607" href="#line607"> 607</a> 	<strong>return</strong> <font color="4444FF">(</font><font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line608" href="#line608"> 608</a> 
<a name="line609" href="#line609"> 609</a>     <font color="#444444">/* Find length of admin structure */</font>
<a name="line610" href="#line610"> 610</a>     <font color="#2040a0">l</font> <font color="4444FF">=</font> <font color="#2040a0">offsetof</font><font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">pginfo</font>, <font color="#2040a0">bits</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line611" href="#line611"> 611</a>     <font color="#2040a0">l</font> <font color="4444FF">+</font><font color="4444FF">=</font> <strong>sizeof</strong> <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">bits</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">*</font>
<a name="line612" href="#line612"> 612</a> 	<font color="4444FF">(</font><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">malloc_pagesize</font> <font color="4444FF">&gt;</font><font color="4444FF">&gt;</font> <font color="#2040a0">bits</font><font color="4444FF">)</font><font color="4444FF">+</font><font color="#2040a0">MALLOC_BITS</font><font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">)</font> / <font color="#2040a0">MALLOC_BITS</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line613" href="#line613"> 613</a> 
<a name="line614" href="#line614"> 614</a>     <font color="#444444">/* Don't waste more than two chunks on this */</font>
<a name="line615" href="#line615"> 615</a>     <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">&lt;</font><font color="4444FF">&lt;</font><font color="4444FF">(</font><font color="#2040a0">bits</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#2040a0">l</font><font color="4444FF">+</font><font color="#2040a0">l</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line616" href="#line616"> 616</a> 	<font color="#2040a0">bp</font> <font color="4444FF">=</font> <font color="4444FF">(</font><strong>struct</strong>  <font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">pp</font><font color="4444FF">;</font>
<a name="line617" href="#line617"> 617</a>     <font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
<a name="line618" href="#line618"> 618</a> 	<font color="#2040a0">bp</font> <font color="4444FF">=</font> <font color="4444FF">(</font><strong>struct</strong>  <font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">imalloc</font><font color="4444FF">(</font><font color="#2040a0">l</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line619" href="#line619"> 619</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">bp</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line620" href="#line620"> 620</a> 	    <font color="#2040a0">ifree</font><font color="4444FF">(</font><font color="#2040a0">pp</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line621" href="#line621"> 621</a> 	    <strong>return</strong> <font color="4444FF">(</font><font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line622" href="#line622"> 622</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line623" href="#line623"> 623</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line624" href="#line624"> 624</a> 
<a name="line625" href="#line625"> 625</a>     <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">&lt;</font><font color="4444FF">&lt;</font><font color="#2040a0">bits</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line626" href="#line626"> 626</a>     <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">shift</font> <font color="4444FF">=</font> <font color="#2040a0">bits</font><font color="4444FF">;</font>
<a name="line627" href="#line627"> 627</a>     <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">total</font> <font color="4444FF">=</font> <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">free</font> <font color="4444FF">=</font> <font color="#2040a0">malloc_pagesize</font> <font color="4444FF">&gt;</font><font color="4444FF">&gt;</font> <font color="#2040a0">bits</font><font color="4444FF">;</font>
<a name="line628" href="#line628"> 628</a>     <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">=</font> <font color="#2040a0">pp</font><font color="4444FF">;</font>
<a name="line629" href="#line629"> 629</a> 
<a name="line630" href="#line630"> 630</a>     <font color="#444444">/* set all valid bits in the bitmap */</font>
<a name="line631" href="#line631"> 631</a>     <font color="#2040a0">k</font> <font color="4444FF">=</font> <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">total</font><font color="4444FF">;</font>
<a name="line632" href="#line632"> 632</a>     <font color="#2040a0">i</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line633" href="#line633"> 633</a> 
<a name="line634" href="#line634"> 634</a>     <font color="#444444">/* Do a bunch at a time */</font>
<a name="line635" href="#line635"> 635</a>     <strong>for</strong><font color="4444FF">(</font><font color="4444FF">;</font><font color="#2040a0">k</font><font color="4444FF">-</font><font color="#2040a0">i</font> <font color="4444FF">&gt;</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_BITS</font><font color="4444FF">;</font> <font color="#2040a0">i</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_BITS</font><font color="4444FF">)</font>
<a name="line636" href="#line636"> 636</a> 	<font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">bits</font><font color="4444FF">[</font><font color="#2040a0">i</font> / <font color="#2040a0">MALLOC_BITS</font><font color="4444FF">]</font> <font color="4444FF">=</font> ~<font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line637" href="#line637"> 637</a> 
<a name="line638" href="#line638"> 638</a>     <strong>for</strong><font color="4444FF">(</font><font color="4444FF">;</font> <font color="#2040a0">i</font> <font color="4444FF">&lt;</font> <font color="#2040a0">k</font><font color="4444FF">;</font> <font color="#2040a0">i</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font>
<a name="line639" href="#line639"> 639</a>         <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">bits</font><font color="4444FF">[</font><font color="#2040a0">i</font>/<font color="#2040a0">MALLOC_BITS</font><font color="4444FF">]</font> <font color="4444FF">|</font><font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">&lt;</font><font color="4444FF">&lt;</font><font color="4444FF">(</font><font color="#2040a0">i</font><font color="4444FF">%</font><font color="#2040a0">MALLOC_BITS</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line640" href="#line640"> 640</a> 
<a name="line641" href="#line641"> 641</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">bp</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line642" href="#line642"> 642</a> 	<font color="#444444">/* Mark the ones we stole for ourselves */</font>
<a name="line643" href="#line643"> 643</a> 	<strong>for</strong><font color="4444FF">(</font><font color="#2040a0">i</font><font color="4444FF">=</font><font color="#FF0000">0</font><font color="4444FF">;</font><font color="#2040a0">l</font> <font color="4444FF">&gt;</font> <font color="#FF0000">0</font><font color="4444FF">;</font><font color="#2040a0">i</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line644" href="#line644"> 644</a> 	    <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">bits</font><font color="4444FF">[</font><font color="#2040a0">i</font>/<font color="#2040a0">MALLOC_BITS</font><font color="4444FF">]</font> <font color="4444FF">&amp;</font><font color="4444FF">=</font> ~<font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">&lt;</font><font color="4444FF">&lt;</font><font color="4444FF">(</font><font color="#2040a0">i</font><font color="4444FF">%</font><font color="#2040a0">MALLOC_BITS</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line645" href="#line645"> 645</a> 	    <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">free</font><font color="4444FF">-</font><font color="4444FF">-</font><font color="4444FF">;</font>
<a name="line646" href="#line646"> 646</a> 	    <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">total</font><font color="4444FF">-</font><font color="4444FF">-</font><font color="4444FF">;</font>
<a name="line647" href="#line647"> 647</a> 	    <font color="#2040a0">l</font> <font color="4444FF">-</font><font color="4444FF">=</font> <font color="4444FF">(</font><font color="#FF0000">1</font> <font color="4444FF">&lt;</font><font color="4444FF">&lt;</font> <font color="#2040a0">bits</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line648" href="#line648"> 648</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line649" href="#line649"> 649</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line650" href="#line650"> 650</a> 
<a name="line651" href="#line651"> 651</a>     <font color="#444444">/* MALLOC_LOCK */</font>
<a name="line652" href="#line652"> 652</a> 
<a name="line653" href="#line653"> 653</a>     <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">ptr2index</font><font color="4444FF">(</font><font color="#2040a0">pp</font><font color="4444FF">)</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">bp</font><font color="4444FF">;</font>
<a name="line654" href="#line654"> 654</a> 
<a name="line655" href="#line655"> 655</a>     <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">bits</font><font color="4444FF">]</font><font color="4444FF">;</font>
<a name="line656" href="#line656"> 656</a>     <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">bits</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">bp</font><font color="4444FF">;</font>
<a name="line657" href="#line657"> 657</a> 
<a name="line658" href="#line658"> 658</a>     <font color="#444444">/* MALLOC_UNLOCK */</font>
<a name="line659" href="#line659"> 659</a> 
<a name="line660" href="#line660"> 660</a>     <strong>return</strong> <font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line661" href="#line661"> 661</a> <font color="4444FF"><strong>}</strong></font>
<a name="line662" href="#line662"> 662</a> 
<a name="line663" href="#line663"> 663</a> <font color="#444444">/*
<a name="line664" href="#line664"> 664</a>  * Allocate a fragment
<a name="line665" href="#line665"> 665</a>  */</font>
<a name="line666" href="#line666"> 666</a> <strong>static</strong> <strong>void</strong> <font color="4444FF">*</font>
<a name="line667" href="#line667"> 667</a> <font color="#2040a0">malloc_bytes</font><font color="4444FF">(</font><font color="#2040a0">size_t</font> <font color="#2040a0">size</font><font color="4444FF">)</font>
<a name="line668" href="#line668"> 668</a> <font color="4444FF"><strong>{</strong></font>
<a name="line669" href="#line669"> 669</a>     <strong>int</strong> <font color="#2040a0">i</font>,<font color="#2040a0">j</font><font color="4444FF">;</font>
<a name="line670" href="#line670"> 670</a>     <font color="#2040a0">u_int</font> <font color="#2040a0">u</font><font color="4444FF">;</font>
<a name="line671" href="#line671"> 671</a>     <strong>struct</strong>  <font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="#2040a0">bp</font><font color="4444FF">;</font>
<a name="line672" href="#line672"> 672</a>     <strong>int</strong> <font color="#2040a0">k</font><font color="4444FF">;</font>
<a name="line673" href="#line673"> 673</a>     <font color="#2040a0">u_int</font> <font color="4444FF">*</font><font color="#2040a0">lp</font><font color="4444FF">;</font>
<a name="line674" href="#line674"> 674</a> 
<a name="line675" href="#line675"> 675</a>     <font color="#444444">/* Don't bother with anything less than this */</font>
<a name="line676" href="#line676"> 676</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">size</font> <font color="4444FF">&lt;</font> <font color="#2040a0">malloc_minsize</font><font color="4444FF">)</font>
<a name="line677" href="#line677"> 677</a> 	<font color="#2040a0">size</font> <font color="4444FF">=</font> <font color="#2040a0">malloc_minsize</font><font color="4444FF">;</font>
<a name="line678" href="#line678"> 678</a> 
<a name="line679" href="#line679"> 679</a>     <font color="#444444">/* Find the right bucket */</font>
<a name="line680" href="#line680"> 680</a>     <font color="#2040a0">j</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line681" href="#line681"> 681</a>     <font color="#2040a0">i</font> <font color="4444FF">=</font> <font color="#2040a0">size</font><font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line682" href="#line682"> 682</a>     <strong>while</strong> <font color="4444FF">(</font><font color="#2040a0">i</font> <font color="4444FF">&gt;</font><font color="4444FF">&gt;</font><font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">)</font>
<a name="line683" href="#line683"> 683</a> 	<font color="#2040a0">j</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">;</font>
<a name="line684" href="#line684"> 684</a> 
<a name="line685" href="#line685"> 685</a>     <font color="#444444">/* If it's empty, make a page more of that size chunks */</font>
<a name="line686" href="#line686"> 686</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">j</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="4444FF">!</font><font color="#2040a0">malloc_make_chunks</font><font color="4444FF">(</font><font color="#2040a0">j</font><font color="4444FF">)</font><font color="4444FF">)</font>
<a name="line687" href="#line687"> 687</a> 	<strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line688" href="#line688"> 688</a> 
<a name="line689" href="#line689"> 689</a>     <font color="#2040a0">bp</font> <font color="4444FF">=</font> <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">j</font><font color="4444FF">]</font><font color="4444FF">;</font>
<a name="line690" href="#line690"> 690</a> 
<a name="line691" href="#line691"> 691</a>     <font color="#444444">/* Find first word of bitmap which isn't empty */</font>
<a name="line692" href="#line692"> 692</a>     <strong>for</strong> <font color="4444FF">(</font><font color="#2040a0">lp</font> <font color="4444FF">=</font> <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">bits</font><font color="4444FF">;</font> <font color="4444FF">!</font><font color="4444FF">*</font><font color="#2040a0">lp</font><font color="4444FF">;</font> <font color="#2040a0">lp</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font>
<a name="line693" href="#line693"> 693</a> 	<font color="4444FF">;</font>
<a name="line694" href="#line694"> 694</a> 
<a name="line695" href="#line695"> 695</a>     <font color="#444444">/* Find that bit, and tweak it */</font>
<a name="line696" href="#line696"> 696</a>     <font color="#2040a0">u</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line697" href="#line697"> 697</a>     <font color="#2040a0">k</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line698" href="#line698"> 698</a>     <strong>while</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">lp</font> <font color="4444FF">&amp;</font> <font color="#2040a0">u</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line699" href="#line699"> 699</a> 	<font color="#2040a0">u</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#2040a0">u</font><font color="4444FF">;</font>
<a name="line700" href="#line700"> 700</a> 	<font color="#2040a0">k</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">;</font>
<a name="line701" href="#line701"> 701</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line702" href="#line702"> 702</a>     <font color="4444FF">*</font><font color="#2040a0">lp</font> ^<font color="4444FF">=</font> <font color="#2040a0">u</font><font color="4444FF">;</font>
<a name="line703" href="#line703"> 703</a> 
<a name="line704" href="#line704"> 704</a>     <font color="#444444">/* If there are no more free, remove from free-list */</font>
<a name="line705" href="#line705"> 705</a>     <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="4444FF">-</font><font color="4444FF">-</font><font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">free</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line706" href="#line706"> 706</a> 	<font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">j</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
<a name="line707" href="#line707"> 707</a> 	<font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line708" href="#line708"> 708</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line709" href="#line709"> 709</a> 
<a name="line710" href="#line710"> 710</a>     <font color="#444444">/* Adjust to the real offset of that chunk */</font>
<a name="line711" href="#line711"> 711</a>     <font color="#2040a0">k</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">lp</font><font color="4444FF">-</font><font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">bits</font><font color="4444FF">)</font><font color="4444FF">*</font><font color="#2040a0">MALLOC_BITS</font><font color="4444FF">;</font>
<a name="line712" href="#line712"> 712</a>     <font color="#2040a0">k</font> <font color="4444FF">&lt;</font><font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">shift</font><font color="4444FF">;</font>
<a name="line713" href="#line713"> 713</a> 
<a name="line714" href="#line714"> 714</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_junk</font><font color="4444FF">)</font>
<a name="line715" href="#line715"> 715</a> 	<font color="#2040a0">memset</font><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_char</font> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">+</font> <font color="#2040a0">k</font>, <font color="#2040a0">SOME_JUNK</font>, <font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line716" href="#line716"> 716</a> 
<a name="line717" href="#line717"> 717</a>     <strong>return</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_char</font> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">bp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">+</font> <font color="#2040a0">k</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line718" href="#line718"> 718</a> <font color="4444FF"><strong>}</strong></font>
<a name="line719" href="#line719"> 719</a> 
<a name="line720" href="#line720"> 720</a> <font color="#444444">/*
<a name="line721" href="#line721"> 721</a>  * Allocate a piece of memory
<a name="line722" href="#line722"> 722</a>  */</font>
<a name="line723" href="#line723"> 723</a> <strong>static</strong> <strong>void</strong> <font color="4444FF">*</font>
<a name="line724" href="#line724"> 724</a> <font color="#2040a0">imalloc</font><font color="4444FF">(</font><font color="#2040a0">size_t</font> <font color="#2040a0">size</font><font color="4444FF">)</font>
<a name="line725" href="#line725"> 725</a> <font color="4444FF"><strong>{</strong></font>
<a name="line726" href="#line726"> 726</a>     <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">result</font><font color="4444FF">;</font>
<a name="line727" href="#line727"> 727</a> 
<a name="line728" href="#line728"> 728</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">suicide</font><font color="4444FF">)</font>
<a name="line729" href="#line729"> 729</a> 	<font color="#2040a0">abort</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line730" href="#line730"> 730</a> 
<a name="line731" href="#line731"> 731</a>     <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">size</font> <font color="4444FF">+</font> <font color="#2040a0">malloc_pagesize</font><font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#2040a0">size</font><font color="4444FF">)</font>	<font color="#444444">/* Check for overflow */</font>
<a name="line732" href="#line732"> 732</a> 	<font color="#2040a0">result</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line733" href="#line733"> 733</a>     <strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">size</font> <font color="4444FF">+</font> <font color="#2040a0">malloc_pagesize</font><font color="4444FF">)</font> <font color="4444FF">&gt;</font><font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">uintptr_t</font><font color="4444FF">)</font><font color="#2040a0">page_dir</font><font color="4444FF">)</font>
<a name="line734" href="#line734"> 734</a> 	<font color="#2040a0">result</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line735" href="#line735"> 735</a>     <strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">size</font> <font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#2040a0">malloc_maxsize</font><font color="4444FF">)</font>
<a name="line736" href="#line736"> 736</a> 	<font color="#2040a0">result</font> <font color="4444FF">=</font> <font color="#2040a0">malloc_bytes</font><font color="4444FF">(</font><font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line737" href="#line737"> 737</a>     <strong>else</strong>
<a name="line738" href="#line738"> 738</a> 	<font color="#2040a0">result</font> <font color="4444FF">=</font> <font color="#2040a0">malloc_pages</font><font color="4444FF">(</font><font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line739" href="#line739"> 739</a> 
<a name="line740" href="#line740"> 740</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_zero</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="#2040a0">result</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line741" href="#line741"> 741</a> 	<font color="#2040a0">memset</font><font color="4444FF">(</font><font color="#2040a0">result</font>, <font color="#FF0000">0</font>, <font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line742" href="#line742"> 742</a> 
<a name="line743" href="#line743"> 743</a>     <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">result</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line744" href="#line744"> 744</a> <font color="4444FF"><strong>}</strong></font>
<a name="line745" href="#line745"> 745</a> 
<a name="line746" href="#line746"> 746</a> <font color="#444444">/*
<a name="line747" href="#line747"> 747</a>  * Change the size of an allocation.
<a name="line748" href="#line748"> 748</a>  */</font>
<a name="line749" href="#line749"> 749</a> <strong>static</strong> <strong>void</strong> <font color="4444FF">*</font>
<a name="line750" href="#line750"> 750</a> <font color="#2040a0">irealloc</font><font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">ptr</font>, <font color="#2040a0">size_t</font> <font color="#2040a0">size</font><font color="4444FF">)</font>
<a name="line751" href="#line751"> 751</a> <font color="4444FF"><strong>{</strong></font>
<a name="line752" href="#line752"> 752</a>     <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">p</font><font color="4444FF">;</font>
<a name="line753" href="#line753"> 753</a>     <font color="#2040a0">u_long</font> <font color="#2040a0">osize</font>, <font color="#2040a0">index</font><font color="4444FF">;</font>
<a name="line754" href="#line754"> 754</a>     <strong>struct</strong> <font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">;</font>
<a name="line755" href="#line755"> 755</a>     <strong>int</strong> <font color="#2040a0">i</font><font color="4444FF">;</font>
<a name="line756" href="#line756"> 756</a> 
<a name="line757" href="#line757"> 757</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">suicide</font><font color="4444FF">)</font>
<a name="line758" href="#line758"> 758</a> 	<font color="#2040a0">abort</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line759" href="#line759"> 759</a> 
<a name="line760" href="#line760"> 760</a>     <font color="#2040a0">index</font> <font color="4444FF">=</font> <font color="#2040a0">ptr2index</font><font color="4444FF">(</font><font color="#2040a0">ptr</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line761" href="#line761"> 761</a> 
<a name="line762" href="#line762"> 762</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">index</font> <font color="4444FF">&lt;</font> <font color="#2040a0">malloc_pageshift</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line763" href="#line763"> 763</a> 	<font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;junk pointer, too low to make sense<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line764" href="#line764"> 764</a> 	<strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line765" href="#line765"> 765</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line766" href="#line766"> 766</a> 
<a name="line767" href="#line767"> 767</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">index</font> <font color="4444FF">&gt;</font> <font color="#2040a0">last_index</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line768" href="#line768"> 768</a> 	<font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;junk pointer, too high to make sense<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line769" href="#line769"> 769</a> 	<strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line770" href="#line770"> 770</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line771" href="#line771"> 771</a> 
<a name="line772" href="#line772"> 772</a>     <font color="#2040a0">mp</font> <font color="4444FF">=</font> <font color="4444FF">&amp;</font><font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">index</font><font color="4444FF">]</font><font color="4444FF">;</font>
<a name="line773" href="#line773"> 773</a> 
<a name="line774" href="#line774"> 774</a>     <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_FIRST</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>			<font color="#444444">/* Page allocation */</font>
<a name="line775" href="#line775"> 775</a> 
<a name="line776" href="#line776"> 776</a> 	<font color="#444444">/* Check the pointer */</font>
<a name="line777" href="#line777"> 777</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_long</font><font color="4444FF">)</font><font color="#2040a0">ptr</font> <font color="4444FF">&amp;</font> <font color="#2040a0">malloc_pagemask</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line778" href="#line778"> 778</a> 	    <font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;modified (page-) pointer<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line779" href="#line779"> 779</a> 	    <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line780" href="#line780"> 780</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line781" href="#line781"> 781</a> 
<a name="line782" href="#line782"> 782</a> 	<font color="#444444">/* Find the size in bytes */</font>
<a name="line783" href="#line783"> 783</a> 	<strong>for</strong> <font color="4444FF">(</font><font color="#2040a0">osize</font> <font color="4444FF">=</font> <font color="#2040a0">malloc_pagesize</font><font color="4444FF">;</font> <font color="4444FF">*</font><font color="4444FF">(</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="#2040a0">mp</font><font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_FOLLOW</font><font color="4444FF">;</font><font color="4444FF">)</font>
<a name="line784" href="#line784"> 784</a> 	    <font color="#2040a0">osize</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#2040a0">malloc_pagesize</font><font color="4444FF">;</font>
<a name="line785" href="#line785"> 785</a> 
<a name="line786" href="#line786"> 786</a>         <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">malloc_realloc</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> 			<font color="#444444">/* Unless we have to, */</font>
<a name="line787" href="#line787"> 787</a> 	  <font color="#2040a0">size</font> <font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#2040a0">osize</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> 			<font color="#444444">/* .. or are too small, */</font>
<a name="line788" href="#line788"> 788</a> 	  <font color="#2040a0">size</font> <font color="4444FF">&gt;</font> <font color="4444FF">(</font><font color="#2040a0">osize</font> <font color="4444FF">-</font> <font color="#2040a0">malloc_pagesize</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>	<font color="#444444">/* .. or can free a page, */</font>
<a name="line789" href="#line789"> 789</a> 	    <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_junk</font><font color="4444FF">)</font>
<a name="line790" href="#line790"> 790</a> 		<font color="#2040a0">memset</font><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_char</font> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">ptr</font> <font color="4444FF">+</font> <font color="#2040a0">size</font>, <font color="#2040a0">SOME_JUNK</font>, <font color="#2040a0">osize</font><font color="4444FF">-</font><font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line791" href="#line791"> 791</a> 	    <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">ptr</font><font color="4444FF">)</font><font color="4444FF">;</font>			<font color="#444444">/* ..don't do anything else. */</font>
<a name="line792" href="#line792"> 792</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line793" href="#line793"> 793</a> 
<a name="line794" href="#line794"> 794</a>     <font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font> <font color="4444FF">&gt;</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_MAGIC</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>		<font color="#444444">/* Chunk allocation */</font>
<a name="line795" href="#line795"> 795</a> 
<a name="line796" href="#line796"> 796</a> 	<font color="#444444">/* Check the pointer for sane values */</font>
<a name="line797" href="#line797"> 797</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_long</font><font color="4444FF">)</font><font color="#2040a0">ptr</font> <font color="4444FF">&amp;</font> <font color="4444FF">(</font><font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font><font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line798" href="#line798"> 798</a> 	    <font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;modified (chunk-) pointer<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line799" href="#line799"> 799</a> 	    <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line800" href="#line800"> 800</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line801" href="#line801"> 801</a> 
<a name="line802" href="#line802"> 802</a> 	<font color="#444444">/* Find the chunk index in the page */</font>
<a name="line803" href="#line803"> 803</a> 	<font color="#2040a0">i</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_long</font><font color="4444FF">)</font><font color="#2040a0">ptr</font> <font color="4444FF">&amp;</font> <font color="#2040a0">malloc_pagemask</font><font color="4444FF">)</font> <font color="4444FF">&gt;</font><font color="4444FF">&gt;</font> <font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">shift</font><font color="4444FF">;</font>
<a name="line804" href="#line804"> 804</a> 
<a name="line805" href="#line805"> 805</a> 	<font color="#444444">/* Verify that it isn't a free chunk already */</font>
<a name="line806" href="#line806"> 806</a>         <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">bits</font><font color="4444FF">[</font><font color="#2040a0">i</font>/<font color="#2040a0">MALLOC_BITS</font><font color="4444FF">]</font> <font color="4444FF">&amp;</font> <font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">&lt;</font><font color="4444FF">&lt;</font><font color="4444FF">(</font><font color="#2040a0">i</font><font color="4444FF">%</font><font color="#2040a0">MALLOC_BITS</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line807" href="#line807"> 807</a> 	    <font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;chunk is already free<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line808" href="#line808"> 808</a> 	    <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line809" href="#line809"> 809</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line810" href="#line810"> 810</a> 
<a name="line811" href="#line811"> 811</a> 	<font color="#2040a0">osize</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font><font color="4444FF">;</font>
<a name="line812" href="#line812"> 812</a> 
<a name="line813" href="#line813"> 813</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">malloc_realloc</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>		<font color="#444444">/* Unless we have to, */</font>
<a name="line814" href="#line814"> 814</a> 	  <font color="#2040a0">size</font> <font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#2040a0">osize</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> 		<font color="#444444">/* ..or are too small, */</font>
<a name="line815" href="#line815"> 815</a> 	  <font color="4444FF">(</font><font color="#2040a0">size</font> <font color="4444FF">&gt;</font> <font color="#2040a0">osize</font>/<font color="#FF0000">2</font> <font color="4444FF">|</font><font color="4444FF">|</font>	 	<font color="#444444">/* ..or could use a smaller size, */</font>
<a name="line816" href="#line816"> 816</a> 	  <font color="#2040a0">osize</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">malloc_minsize</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>	<font color="#444444">/* ..(if there is one) */</font>
<a name="line817" href="#line817"> 817</a> 	    <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_junk</font><font color="4444FF">)</font>
<a name="line818" href="#line818"> 818</a> 		<font color="#2040a0">memset</font><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_char</font> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">ptr</font> <font color="4444FF">+</font> <font color="#2040a0">size</font>, <font color="#2040a0">SOME_JUNK</font>, <font color="#2040a0">osize</font><font color="4444FF">-</font><font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line819" href="#line819"> 819</a> 	    <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">ptr</font><font color="4444FF">)</font><font color="4444FF">;</font>		<font color="#444444">/* ..don't do anything else. */</font>
<a name="line820" href="#line820"> 820</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line821" href="#line821"> 821</a> 
<a name="line822" href="#line822"> 822</a>     <font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
<a name="line823" href="#line823"> 823</a> 	<font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;pointer to wrong page<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line824" href="#line824"> 824</a> 	<strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line825" href="#line825"> 825</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line826" href="#line826"> 826</a> 
<a name="line827" href="#line827"> 827</a>     <font color="#2040a0">p</font> <font color="4444FF">=</font> <font color="#2040a0">imalloc</font><font color="4444FF">(</font><font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line828" href="#line828"> 828</a> 
<a name="line829" href="#line829"> 829</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">p</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line830" href="#line830"> 830</a> 	<font color="#444444">/* copy the lesser of the two sizes, and free the old one */</font>
<a name="line831" href="#line831"> 831</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">size</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="4444FF">!</font><font color="#2040a0">osize</font><font color="4444FF">)</font>
<a name="line832" href="#line832"> 832</a> 	    <font color="4444FF">;</font>
<a name="line833" href="#line833"> 833</a> 	<strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">osize</font> <font color="4444FF">&lt;</font> <font color="#2040a0">size</font><font color="4444FF">)</font>
<a name="line834" href="#line834"> 834</a> 	    <font color="#2040a0">memcpy</font><font color="4444FF">(</font><font color="#2040a0">p</font>, <font color="#2040a0">ptr</font>, <font color="#2040a0">osize</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line835" href="#line835"> 835</a> 	<strong>else</strong>
<a name="line836" href="#line836"> 836</a> 	    <font color="#2040a0">memcpy</font><font color="4444FF">(</font><font color="#2040a0">p</font>, <font color="#2040a0">ptr</font>, <font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line837" href="#line837"> 837</a> 	<font color="#2040a0">ifree</font><font color="4444FF">(</font><font color="#2040a0">ptr</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line838" href="#line838"> 838</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line839" href="#line839"> 839</a>     <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">p</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line840" href="#line840"> 840</a> <font color="4444FF"><strong>}</strong></font>
<a name="line841" href="#line841"> 841</a> 
<a name="line842" href="#line842"> 842</a> <font color="#444444">/*
<a name="line843" href="#line843"> 843</a>  * Free a sequence of pages
<a name="line844" href="#line844"> 844</a>  */</font>
<a name="line845" href="#line845"> 845</a> 
<a name="line846" href="#line846"> 846</a> <strong>static</strong> <font color="#2040a0">__inline__</font> <strong>void</strong>
<a name="line847" href="#line847"> 847</a> <font color="#2040a0">free_pages</font><font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">ptr</font>, <font color="#2040a0">u_long</font> <font color="#2040a0">index</font>, <strong>struct</strong> <font color="#2040a0">pginfo</font> <strong>const</strong> <font color="4444FF">*</font><font color="#2040a0">info</font><font color="4444FF">)</font>
<a name="line848" href="#line848"> 848</a> <font color="4444FF"><strong>{</strong></font>
<a name="line849" href="#line849"> 849</a>     <font color="#2040a0">u_long</font> <font color="#2040a0">i</font><font color="4444FF">;</font>
<a name="line850" href="#line850"> 850</a>     <strong>struct</strong> <font color="#2040a0">pgfree</font> <font color="4444FF">*</font><font color="#2040a0">pf</font>, <font color="4444FF">*</font><font color="#2040a0">pt</font><font color="4444FF">=</font><font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line851" href="#line851"> 851</a>     <font color="#2040a0">u_long</font> <font color="#2040a0">l</font><font color="4444FF">;</font>
<a name="line852" href="#line852"> 852</a>     <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">tail</font><font color="4444FF">;</font>
<a name="line853" href="#line853"> 853</a> 
<a name="line854" href="#line854"> 854</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">info</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_FREE</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line855" href="#line855"> 855</a> 	<font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;page is already free<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line856" href="#line856"> 856</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line857" href="#line857"> 857</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line858" href="#line858"> 858</a> 
<a name="line859" href="#line859"> 859</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">info</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_FIRST</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line860" href="#line860"> 860</a> 	<font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;pointer to wrong page<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line861" href="#line861"> 861</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line862" href="#line862"> 862</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line863" href="#line863"> 863</a> 
<a name="line864" href="#line864"> 864</a>     <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_long</font><font color="4444FF">)</font><font color="#2040a0">ptr</font> <font color="4444FF">&amp;</font> <font color="#2040a0">malloc_pagemask</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line865" href="#line865"> 865</a> 	<font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;modified (page-) pointer<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line866" href="#line866"> 866</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line867" href="#line867"> 867</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line868" href="#line868"> 868</a> 
<a name="line869" href="#line869"> 869</a>     <font color="#444444">/* Count how many pages and mark them free at the same time */</font>
<a name="line870" href="#line870"> 870</a>     <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">index</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">MALLOC_FREE</font><font color="4444FF">;</font>
<a name="line871" href="#line871"> 871</a>     <strong>for</strong> <font color="4444FF">(</font><font color="#2040a0">i</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font> <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">index</font><font color="4444FF">+</font><font color="#2040a0">i</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">MALLOC_FOLLOW</font><font color="4444FF">;</font> <font color="#2040a0">i</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font>
<a name="line872" href="#line872"> 872</a> 	<font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">index</font> <font color="4444FF">+</font> <font color="#2040a0">i</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">MALLOC_FREE</font><font color="4444FF">;</font>
<a name="line873" href="#line873"> 873</a> 
<a name="line874" href="#line874"> 874</a>     <font color="#2040a0">l</font> <font color="4444FF">=</font> <font color="#2040a0">i</font> <font color="4444FF">&lt;</font><font color="4444FF">&lt;</font> <font color="#2040a0">malloc_pageshift</font><font color="4444FF">;</font>
<a name="line875" href="#line875"> 875</a> 
<a name="line876" href="#line876"> 876</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_junk</font><font color="4444FF">)</font>
<a name="line877" href="#line877"> 877</a> 	<font color="#2040a0">memset</font><font color="4444FF">(</font><font color="#2040a0">ptr</font>, <font color="#2040a0">SOME_JUNK</font>, <font color="#2040a0">l</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line878" href="#line878"> 878</a> 
<a name="line879" href="#line879"> 879</a> <font color="0000ff"><strong>#if defined(MADV_FREE)</strong></font>
<a name="line880" href="#line880"> 880</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_hint</font><font color="4444FF">)</font>
<a name="line881" href="#line881"> 881</a> 	<font color="#2040a0">madvise</font><font color="4444FF">(</font><font color="#2040a0">ptr</font>, <font color="#2040a0">l</font>, <font color="#2040a0">MADV_FREE</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line882" href="#line882"> 882</a> <font color="0000ff"><strong>#endif</strong></font>
<a name="line883" href="#line883"> 883</a> 
<a name="line884" href="#line884"> 884</a>     <font color="#2040a0">tail</font> <font color="4444FF">=</font> <font color="4444FF">(</font><strong>char</strong> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">ptr</font><font color="4444FF">+</font><font color="#2040a0">l</font><font color="4444FF">;</font>
<a name="line885" href="#line885"> 885</a> 
<a name="line886" href="#line886"> 886</a>     <font color="#444444">/* add to free-list */</font>
<a name="line887" href="#line887"> 887</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">px</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line888" href="#line888"> 888</a> 	<font color="#2040a0">px</font> <font color="4444FF">=</font> <font color="#2040a0">imalloc</font><font color="4444FF">(</font><strong>sizeof</strong> <font color="4444FF">*</font><font color="#2040a0">px</font><font color="4444FF">)</font><font color="4444FF">;</font>	<font color="#444444">/* This cannot fail... */</font>
<a name="line889" href="#line889"> 889</a>     <font color="#2040a0">px</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">=</font> <font color="#2040a0">ptr</font><font color="4444FF">;</font>
<a name="line890" href="#line890"> 890</a>     <font color="#2040a0">px</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font> <font color="4444FF">=</font>  <font color="#2040a0">tail</font><font color="4444FF">;</font>
<a name="line891" href="#line891"> 891</a>     <font color="#2040a0">px</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">=</font> <font color="#2040a0">l</font><font color="4444FF">;</font>
<a name="line892" href="#line892"> 892</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">free_list</font>.<font color="#2040a0">next</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line893" href="#line893"> 893</a> 
<a name="line894" href="#line894"> 894</a> 	<font color="#444444">/* Nothing on free list, put this at head */</font>
<a name="line895" href="#line895"> 895</a> 	<font color="#2040a0">px</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">free_list</font>.<font color="#2040a0">next</font><font color="4444FF">;</font>
<a name="line896" href="#line896"> 896</a> 	<font color="#2040a0">px</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font> <font color="4444FF">=</font> <font color="4444FF">&amp;</font><font color="#2040a0">free_list</font><font color="4444FF">;</font>
<a name="line897" href="#line897"> 897</a> 	<font color="#2040a0">free_list</font>.<font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">px</font><font color="4444FF">;</font>
<a name="line898" href="#line898"> 898</a> 	<font color="#2040a0">pf</font> <font color="4444FF">=</font> <font color="#2040a0">px</font><font color="4444FF">;</font>
<a name="line899" href="#line899"> 899</a> 	<font color="#2040a0">px</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line900" href="#line900"> 900</a> 
<a name="line901" href="#line901"> 901</a>     <font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
<a name="line902" href="#line902"> 902</a> 
<a name="line903" href="#line903"> 903</a> 	<font color="#444444">/* Find the right spot, leave pf pointing to the modified entry. */</font>
<a name="line904" href="#line904"> 904</a> 	<font color="#2040a0">tail</font> <font color="4444FF">=</font> <font color="4444FF">(</font><strong>char</strong> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">ptr</font><font color="4444FF">+</font><font color="#2040a0">l</font><font color="4444FF">;</font>
<a name="line905" href="#line905"> 905</a> 
<a name="line906" href="#line906"> 906</a> 	<strong>for</strong><font color="4444FF">(</font><font color="#2040a0">pf</font> <font color="4444FF">=</font> <font color="#2040a0">free_list</font>.<font color="#2040a0">next</font><font color="4444FF">;</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font> <font color="4444FF">&lt;</font> <font color="#2040a0">ptr</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line907" href="#line907"> 907</a> 	    <font color="#2040a0">pf</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">)</font>
<a name="line908" href="#line908"> 908</a> 	    <font color="4444FF">;</font> <font color="#444444">/* Race ahead here */</font>
<a name="line909" href="#line909"> 909</a> 
<a name="line910" href="#line910"> 910</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">&gt;</font> <font color="#2040a0">tail</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line911" href="#line911"> 911</a> 	    <font color="#444444">/* Insert before entry */</font>
<a name="line912" href="#line912"> 912</a> 	    <font color="#2040a0">px</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">;</font>
<a name="line913" href="#line913"> 913</a> 	    <font color="#2040a0">px</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font><font color="4444FF">;</font>
<a name="line914" href="#line914"> 914</a> 	    <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font> <font color="4444FF">=</font> <font color="#2040a0">px</font><font color="4444FF">;</font>
<a name="line915" href="#line915"> 915</a> 	    <font color="#2040a0">px</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">px</font><font color="4444FF">;</font>
<a name="line916" href="#line916"> 916</a> 	    <font color="#2040a0">pf</font> <font color="4444FF">=</font> <font color="#2040a0">px</font><font color="4444FF">;</font>
<a name="line917" href="#line917"> 917</a> 	    <font color="#2040a0">px</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line918" href="#line918"> 918</a> 	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ptr</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line919" href="#line919"> 919</a> 	    <font color="#444444">/* Append to the previous entry */</font>
<a name="line920" href="#line920"> 920</a> 	    <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font> <font color="4444FF">=</font> <font color="4444FF">(</font><strong>char</strong> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font> <font color="4444FF">+</font> <font color="#2040a0">l</font><font color="4444FF">;</font>
<a name="line921" href="#line921"> 921</a> 	    <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#2040a0">l</font><font color="4444FF">;</font>
<a name="line922" href="#line922"> 922</a> 	    <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line923" href="#line923"> 923</a> 		<font color="#444444">/* And collapse the next too. */</font>
<a name="line924" href="#line924"> 924</a> 		<font color="#2040a0">pt</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
<a name="line925" href="#line925"> 925</a> 		<font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font> <font color="4444FF">=</font> <font color="#2040a0">pt</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font><font color="4444FF">;</font>
<a name="line926" href="#line926"> 926</a> 		<font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#2040a0">pt</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font><font color="4444FF">;</font>
<a name="line927" href="#line927"> 927</a> 		<font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">pt</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
<a name="line928" href="#line928"> 928</a> 		<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line929" href="#line929"> 929</a> 		    <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">;</font>
<a name="line930" href="#line930"> 930</a> 	    <font color="4444FF"><strong>}</strong></font>
<a name="line931" href="#line931"> 931</a> 	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">tail</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line932" href="#line932"> 932</a> 	    <font color="#444444">/* Prepend to entry */</font>
<a name="line933" href="#line933"> 933</a> 	    <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#2040a0">l</font><font color="4444FF">;</font>
<a name="line934" href="#line934"> 934</a> 	    <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">=</font> <font color="#2040a0">ptr</font><font color="4444FF">;</font>
<a name="line935" href="#line935"> 935</a> 	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line936" href="#line936"> 936</a> 	    <font color="#444444">/* Append at tail of chain */</font>
<a name="line937" href="#line937"> 937</a> 	    <font color="#2040a0">px</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line938" href="#line938"> 938</a> 	    <font color="#2040a0">px</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">;</font>
<a name="line939" href="#line939"> 939</a> 	    <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">px</font><font color="4444FF">;</font>
<a name="line940" href="#line940"> 940</a> 	    <font color="#2040a0">pf</font> <font color="4444FF">=</font> <font color="#2040a0">px</font><font color="4444FF">;</font>
<a name="line941" href="#line941"> 941</a> 	    <font color="#2040a0">px</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line942" href="#line942"> 942</a> 	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
<a name="line943" href="#line943"> 943</a> 	    <font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;freelist is destroyed<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line944" href="#line944"> 944</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line945" href="#line945"> 945</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line946" href="#line946"> 946</a> 
<a name="line947" href="#line947"> 947</a>     <font color="#444444">/* Return something to OS ? */</font>
<a name="line948" href="#line948"> 948</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>			<font color="#444444">/* If we're the last one, */</font>
<a name="line949" href="#line949"> 949</a>       <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">&gt;</font> <font color="#2040a0">malloc_cache</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>		<font color="#444444">/* ..and the cache is full, */</font>
<a name="line950" href="#line950"> 950</a>       <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">malloc_brk</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>			<font color="#444444">/* ..and none behind us, */</font>
<a name="line951" href="#line951"> 951</a>       <font color="#2040a0">malloc_brk</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">sbrk</font><font color="4444FF">(</font><font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>			<font color="#444444">/* ..and it's OK to do... */</font>
<a name="line952" href="#line952"> 952</a> 
<a name="line953" href="#line953"> 953</a> 	<font color="#444444">/*
<a name="line954" href="#line954"> 954</a> 	 * Keep the cache intact.  Notice that the '&gt;' above guarantees that
<a name="line955" href="#line955"> 955</a> 	 * the pf will always have at least one page afterwards.
<a name="line956" href="#line956"> 956</a> 	 */</font>
<a name="line957" href="#line957"> 957</a> 	<font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font> <font color="4444FF">=</font> <font color="4444FF">(</font><strong>char</strong> <font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">+</font> <font color="#2040a0">malloc_cache</font><font color="4444FF">;</font>
<a name="line958" href="#line958"> 958</a> 	<font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">=</font> <font color="#2040a0">malloc_cache</font><font color="4444FF">;</font>
<a name="line959" href="#line959"> 959</a> 
<a name="line960" href="#line960"> 960</a> 	<font color="#2040a0">brk</font><font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line961" href="#line961"> 961</a> 	<font color="#2040a0">malloc_brk</font> <font color="4444FF">=</font> <font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font><font color="4444FF">;</font>
<a name="line962" href="#line962"> 962</a> 
<a name="line963" href="#line963"> 963</a> 	<font color="#2040a0">index</font> <font color="4444FF">=</font> <font color="#2040a0">ptr2index</font><font color="4444FF">(</font><font color="#2040a0">pf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">end</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line964" href="#line964"> 964</a> 
<a name="line965" href="#line965"> 965</a> 	<strong>for</strong><font color="4444FF">(</font><font color="#2040a0">i</font><font color="4444FF">=</font><font color="#2040a0">index</font><font color="4444FF">;</font><font color="#2040a0">i</font> <font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#2040a0">last_index</font><font color="4444FF">;</font><font color="4444FF">)</font>
<a name="line966" href="#line966"> 966</a> 	    <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">i</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">MALLOC_NOT_MINE</font><font color="4444FF">;</font>
<a name="line967" href="#line967"> 967</a> 
<a name="line968" href="#line968"> 968</a> 	<font color="#2040a0">last_index</font> <font color="4444FF">=</font> <font color="#2040a0">index</font> <font color="4444FF">-</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line969" href="#line969"> 969</a> 
<a name="line970" href="#line970"> 970</a> 	<font color="#444444">/* XXX: We could realloc/shrink the pagedir here I guess. */</font>
<a name="line971" href="#line971"> 971</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line972" href="#line972"> 972</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">pt</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line973" href="#line973"> 973</a> 	<font color="#2040a0">ifree</font><font color="4444FF">(</font><font color="#2040a0">pt</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line974" href="#line974"> 974</a> <font color="4444FF"><strong>}</strong></font>
<a name="line975" href="#line975"> 975</a> 
<a name="line976" href="#line976"> 976</a> <font color="#444444">/*
<a name="line977" href="#line977"> 977</a>  * Free a chunk, and possibly the page it's on, if the page becomes empty.
<a name="line978" href="#line978"> 978</a>  */</font>
<a name="line979" href="#line979"> 979</a> 
<a name="line980" href="#line980"> 980</a> <strong>static</strong> <font color="#2040a0">__inline__</font> <strong>void</strong>
<a name="line981" href="#line981"> 981</a> <font color="#2040a0">free_bytes</font><font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">ptr</font>, <font color="#2040a0">u_long</font> <font color="#2040a0">index</font>, <strong>struct</strong> <font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="#2040a0">info</font><font color="4444FF">)</font>
<a name="line982" href="#line982"> 982</a> <font color="4444FF"><strong>{</strong></font>
<a name="line983" href="#line983"> 983</a>     <strong>int</strong> <font color="#2040a0">i</font><font color="4444FF">;</font>
<a name="line984" href="#line984"> 984</a>     <strong>struct</strong> <font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">;</font>
<a name="line985" href="#line985"> 985</a>     <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">vp</font><font color="4444FF">;</font>
<a name="line986" href="#line986"> 986</a> 
<a name="line987" href="#line987"> 987</a>     <font color="#444444">/* Find the chunk number on the page */</font>
<a name="line988" href="#line988"> 988</a>     <font color="#2040a0">i</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_long</font><font color="4444FF">)</font><font color="#2040a0">ptr</font> <font color="4444FF">&amp;</font> <font color="#2040a0">malloc_pagemask</font><font color="4444FF">)</font> <font color="4444FF">&gt;</font><font color="4444FF">&gt;</font> <font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">shift</font><font color="4444FF">;</font>
<a name="line989" href="#line989"> 989</a> 
<a name="line990" href="#line990"> 990</a>     <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">(</font><font color="4444FF">(</font><font color="#2040a0">u_long</font><font color="4444FF">)</font><font color="#2040a0">ptr</font> <font color="4444FF">&amp;</font> <font color="4444FF">(</font><font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font><font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line991" href="#line991"> 991</a> 	<font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;modified (chunk-) pointer<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line992" href="#line992"> 992</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line993" href="#line993"> 993</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line994" href="#line994"> 994</a> 
<a name="line995" href="#line995"> 995</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">bits</font><font color="4444FF">[</font><font color="#2040a0">i</font>/<font color="#2040a0">MALLOC_BITS</font><font color="4444FF">]</font> <font color="4444FF">&amp;</font> <font color="4444FF">(</font><font color="#FF0000">1</font><font color="4444FF">&lt;</font><font color="4444FF">&lt;</font><font color="4444FF">(</font><font color="#2040a0">i</font><font color="4444FF">%</font><font color="#2040a0">MALLOC_BITS</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line996" href="#line996"> 996</a> 	<font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;chunk is already free<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line997" href="#line997"> 997</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line998" href="#line998"> 998</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line999" href="#line999"> 999</a> 
<a name="line1000" href="#line1000">1000</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_junk</font><font color="4444FF">)</font>
<a name="line1001" href="#line1001">1001</a> 	<font color="#2040a0">memset</font><font color="4444FF">(</font><font color="#2040a0">ptr</font>, <font color="#2040a0">SOME_JUNK</font>, <font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1002" href="#line1002">1002</a> 
<a name="line1003" href="#line1003">1003</a>     <font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">bits</font><font color="4444FF">[</font><font color="#2040a0">i</font>/<font color="#2040a0">MALLOC_BITS</font><font color="4444FF">]</font> <font color="4444FF">|</font><font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">&lt;</font><font color="4444FF">&lt;</font><font color="4444FF">(</font><font color="#2040a0">i</font><font color="4444FF">%</font><font color="#2040a0">MALLOC_BITS</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1004" href="#line1004">1004</a>     <font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">free</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">;</font>
<a name="line1005" href="#line1005">1005</a> 
<a name="line1006" href="#line1006">1006</a>     <font color="#2040a0">mp</font> <font color="4444FF">=</font> <font color="#2040a0">page_dir</font> <font color="4444FF">+</font> <font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">shift</font><font color="4444FF">;</font>
<a name="line1007" href="#line1007">1007</a> 
<a name="line1008" href="#line1008">1008</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">free</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1009" href="#line1009">1009</a> 
<a name="line1010" href="#line1010">1010</a> 	<font color="#444444">/* Page became non-full */</font>
<a name="line1011" href="#line1011">1011</a> 
<a name="line1012" href="#line1012">1012</a> 	<font color="#2040a0">mp</font> <font color="4444FF">=</font> <font color="#2040a0">page_dir</font> <font color="4444FF">+</font> <font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">shift</font><font color="4444FF">;</font>
<a name="line1013" href="#line1013">1013</a> 	<font color="#444444">/* Insert in address order */</font>
<a name="line1014" href="#line1014">1014</a> 	<strong>while</strong> <font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font> <font color="4444FF">&lt;</font> <font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font><font color="4444FF">)</font>
<a name="line1015" href="#line1015">1015</a> 	    <font color="#2040a0">mp</font> <font color="4444FF">=</font> <font color="4444FF">&amp;</font><font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
<a name="line1016" href="#line1016">1016</a> 	<font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">;</font>
<a name="line1017" href="#line1017">1017</a> 	<font color="4444FF">*</font><font color="#2040a0">mp</font> <font color="4444FF">=</font> <font color="#2040a0">info</font><font color="4444FF">;</font>
<a name="line1018" href="#line1018">1018</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line1019" href="#line1019">1019</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line1020" href="#line1020">1020</a> 
<a name="line1021" href="#line1021">1021</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">free</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">total</font><font color="4444FF">)</font>
<a name="line1022" href="#line1022">1022</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line1023" href="#line1023">1023</a> 
<a name="line1024" href="#line1024">1024</a>     <font color="#444444">/* Find &amp; remove this page in the queue */</font>
<a name="line1025" href="#line1025">1025</a>     <strong>while</strong> <font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">info</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1026" href="#line1026">1026</a> 	<font color="#2040a0">mp</font> <font color="4444FF">=</font> <font color="4444FF">&amp;</font><font color="4444FF">(</font><font color="4444FF">(</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1027" href="#line1027">1027</a> <font color="0000ff"><strong>#ifdef MALLOC_EXTRA_SANITY</strong></font>
<a name="line1028" href="#line1028">1028</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="4444FF">*</font><font color="#2040a0">mp</font><font color="4444FF">)</font>
<a name="line1029" href="#line1029">1029</a> 		<font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;(ES): Not on queue<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1030" href="#line1030">1030</a> <font color="0000ff"><strong>#endif<font color="#444444"> /* MALLOC_EXTRA_SANITY */</font></strong></font>
<a name="line1031" href="#line1031">1031</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line1032" href="#line1032">1032</a>     <font color="4444FF">*</font><font color="#2040a0">mp</font> <font color="4444FF">=</font> <font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
<a name="line1033" href="#line1033">1033</a> 
<a name="line1034" href="#line1034">1034</a>     <font color="#444444">/* Free the page &amp; the info structure if need be */</font>
<a name="line1035" href="#line1035">1035</a>     <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">ptr2index</font><font color="4444FF">(</font><font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font><font color="4444FF">)</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">MALLOC_FIRST</font><font color="4444FF">;</font>
<a name="line1036" href="#line1036">1036</a>     <font color="#2040a0">vp</font> <font color="4444FF">=</font> <font color="#2040a0">info</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">page</font><font color="4444FF">;</font>		<font color="#444444">/* Order is important ! */</font>
<a name="line1037" href="#line1037">1037</a>     <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">vp</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="4444FF">(</font><strong>void</strong><font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">info</font><font color="4444FF">)</font>
<a name="line1038" href="#line1038">1038</a> 	<font color="#2040a0">ifree</font><font color="4444FF">(</font><font color="#2040a0">info</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1039" href="#line1039">1039</a>     <font color="#2040a0">ifree</font><font color="4444FF">(</font><font color="#2040a0">vp</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1040" href="#line1040">1040</a> <font color="4444FF"><strong>}</strong></font>
<a name="line1041" href="#line1041">1041</a> 
<a name="line1042" href="#line1042">1042</a> <strong>static</strong> <strong>void</strong>
<a name="line1043" href="#line1043">1043</a> <font color="#2040a0">ifree</font><font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">ptr</font><font color="4444FF">)</font>
<a name="line1044" href="#line1044">1044</a> <font color="4444FF"><strong>{</strong></font>
<a name="line1045" href="#line1045">1045</a>     <strong>struct</strong> <font color="#2040a0">pginfo</font> <font color="4444FF">*</font><font color="#2040a0">info</font><font color="4444FF">;</font>
<a name="line1046" href="#line1046">1046</a>     <font color="#2040a0">u_long</font> <font color="#2040a0">index</font><font color="4444FF">;</font>
<a name="line1047" href="#line1047">1047</a> 
<a name="line1048" href="#line1048">1048</a>     <font color="#444444">/* This is legal */</font>
<a name="line1049" href="#line1049">1049</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">ptr</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line1050" href="#line1050">1050</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line1051" href="#line1051">1051</a> 
<a name="line1052" href="#line1052">1052</a>     <font color="#444444">/* If we're already sinking, don't make matters any worse. */</font>
<a name="line1053" href="#line1053">1053</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">suicide</font><font color="4444FF">)</font>
<a name="line1054" href="#line1054">1054</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line1055" href="#line1055">1055</a> 
<a name="line1056" href="#line1056">1056</a>     <font color="#2040a0">index</font> <font color="4444FF">=</font> <font color="#2040a0">ptr2index</font><font color="4444FF">(</font><font color="#2040a0">ptr</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1057" href="#line1057">1057</a> 
<a name="line1058" href="#line1058">1058</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">index</font> <font color="4444FF">&lt;</font> <font color="#2040a0">malloc_pageshift</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1059" href="#line1059">1059</a> 	<font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;junk pointer, too low to make sense<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1060" href="#line1060">1060</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line1061" href="#line1061">1061</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line1062" href="#line1062">1062</a> 
<a name="line1063" href="#line1063">1063</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">index</font> <font color="4444FF">&gt;</font> <font color="#2040a0">last_index</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1064" href="#line1064">1064</a> 	<font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;junk pointer, too high to make sense<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1065" href="#line1065">1065</a> 	<strong>return</strong><font color="4444FF">;</font>
<a name="line1066" href="#line1066">1066</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line1067" href="#line1067">1067</a> 
<a name="line1068" href="#line1068">1068</a>     <font color="#2040a0">info</font> <font color="4444FF">=</font> <font color="#2040a0">page_dir</font><font color="4444FF">[</font><font color="#2040a0">index</font><font color="4444FF">]</font><font color="4444FF">;</font>
<a name="line1069" href="#line1069">1069</a> 
<a name="line1070" href="#line1070">1070</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">info</font> <font color="4444FF">&lt;</font> <font color="#2040a0">MALLOC_MAGIC</font><font color="4444FF">)</font>
<a name="line1071" href="#line1071">1071</a>         <font color="#2040a0">free_pages</font><font color="4444FF">(</font><font color="#2040a0">ptr</font>, <font color="#2040a0">index</font>, <font color="#2040a0">info</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1072" href="#line1072">1072</a>     <strong>else</strong>
<a name="line1073" href="#line1073">1073</a> 	<font color="#2040a0">free_bytes</font><font color="4444FF">(</font><font color="#2040a0">ptr</font>, <font color="#2040a0">index</font>, <font color="#2040a0">info</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1074" href="#line1074">1074</a>     <strong>return</strong><font color="4444FF">;</font>
<a name="line1075" href="#line1075">1075</a> <font color="4444FF"><strong>}</strong></font>
<a name="line1076" href="#line1076">1076</a> 
<a name="line1077" href="#line1077">1077</a> <strong>static</strong> <strong>void</strong> <font color="4444FF">*</font>
<a name="line1078" href="#line1078">1078</a> <font color="#2040a0">pubrealloc</font><font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">ptr</font>, <font color="#2040a0">size_t</font> <font color="#2040a0">size</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">func</font><font color="4444FF">)</font>
<a name="line1079" href="#line1079">1079</a> <font color="4444FF"><strong>{</strong></font>
<a name="line1080" href="#line1080">1080</a>     <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">r</font><font color="4444FF">;</font>
<a name="line1081" href="#line1081">1081</a>     <strong>int</strong> <font color="#2040a0">err</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line1082" href="#line1082">1082</a>     <strong>static</strong> <strong>int</strong> <font color="#2040a0">malloc_active</font><font color="4444FF">;</font> <font color="#444444">/* Recusion flag for public interface. */</font>
<a name="line1083" href="#line1083">1083</a>     <strong>static</strong> <strong>unsigned</strong> <font color="#2040a0">malloc_started</font><font color="4444FF">;</font> <font color="#444444">/* Set when initialization has been done */</font>
<a name="line1084" href="#line1084">1084</a> 
<a name="line1085" href="#line1085">1085</a>     <font color="#444444">/*
<a name="line1086" href="#line1086">1086</a>      * If a thread is inside our code with a functional lock held, and then
<a name="line1087" href="#line1087">1087</a>      * catches a signal which calls us again, we would get a deadlock if the
<a name="line1088" href="#line1088">1088</a>      * lock is not of a recursive type.
<a name="line1089" href="#line1089">1089</a>      */</font>
<a name="line1090" href="#line1090">1090</a>     <font color="#2040a0">_MALLOC_LOCK</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1091" href="#line1091">1091</a>     <font color="#2040a0">malloc_func</font> <font color="4444FF">=</font> <font color="#2040a0">func</font><font color="4444FF">;</font>
<a name="line1092" href="#line1092">1092</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_active</font> <font color="4444FF">&gt;</font> <font color="#FF0000">0</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1093" href="#line1093">1093</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_active</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1094" href="#line1094">1094</a> 	    <font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;recursive call<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1095" href="#line1095">1095</a> 	    <font color="#2040a0">malloc_active</font> <font color="4444FF">=</font> <font color="#FF0000">2</font><font color="4444FF">;</font>
<a name="line1096" href="#line1096">1096</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line1097" href="#line1097">1097</a>         <font color="#2040a0">_MALLOC_UNLOCK</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1098" href="#line1098">1098</a> 	<font color="#2040a0">errno</font> <font color="4444FF">=</font> <font color="#2040a0">EDOOFUS</font><font color="4444FF">;</font>
<a name="line1099" href="#line1099">1099</a> 	<strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1100" href="#line1100">1100</a>     <font color="4444FF"><strong>}</strong></font> 
<a name="line1101" href="#line1101">1101</a>     <font color="#2040a0">malloc_active</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line1102" href="#line1102">1102</a> 
<a name="line1103" href="#line1103">1103</a>     <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">malloc_started</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1104" href="#line1104">1104</a>         <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">ptr</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1105" href="#line1105">1105</a> 	    <font color="#2040a0">wrtwarning</font><font color="4444FF">(</font><font color="#008000">&quot;malloc() has never been called<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1106" href="#line1106">1106</a> 	    <font color="#2040a0">malloc_active</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line1107" href="#line1107">1107</a>             <font color="#2040a0">_MALLOC_UNLOCK</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1108" href="#line1108">1108</a> 	    <font color="#2040a0">errno</font> <font color="4444FF">=</font> <font color="#2040a0">EDOOFUS</font><font color="4444FF">;</font>
<a name="line1109" href="#line1109">1109</a> 	    <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1110" href="#line1110">1110</a> 	<font color="4444FF"><strong>}</strong></font>
<a name="line1111" href="#line1111">1111</a> 	<font color="#2040a0">malloc_init</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1112" href="#line1112">1112</a> 	<font color="#2040a0">malloc_started</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
<a name="line1113" href="#line1113">1113</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line1114" href="#line1114">1114</a>    
<a name="line1115" href="#line1115">1115</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">ptr</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ZEROSIZEPTR</font><font color="4444FF">)</font>
<a name="line1116" href="#line1116">1116</a> 	<font color="#2040a0">ptr</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line1117" href="#line1117">1117</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_sysv</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="4444FF">!</font><font color="#2040a0">size</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1118" href="#line1118">1118</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">ptr</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line1119" href="#line1119">1119</a> 	    <font color="#2040a0">ifree</font><font color="4444FF">(</font><font color="#2040a0">ptr</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1120" href="#line1120">1120</a> 	<font color="#2040a0">r</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
<a name="line1121" href="#line1121">1121</a>     <font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">size</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1122" href="#line1122">1122</a> 	<strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">ptr</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font>
<a name="line1123" href="#line1123">1123</a> 	    <font color="#2040a0">ifree</font><font color="4444FF">(</font><font color="#2040a0">ptr</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1124" href="#line1124">1124</a> 	<font color="#2040a0">r</font> <font color="4444FF">=</font> <font color="#2040a0">ZEROSIZEPTR</font><font color="4444FF">;</font>
<a name="line1125" href="#line1125">1125</a>     <font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">ptr</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
<a name="line1126" href="#line1126">1126</a> 	<font color="#2040a0">r</font> <font color="4444FF">=</font> <font color="#2040a0">imalloc</font><font color="4444FF">(</font><font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1127" href="#line1127">1127</a> 	<font color="#2040a0">err</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">r</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1128" href="#line1128">1128</a>     <font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
<a name="line1129" href="#line1129">1129</a>         <font color="#2040a0">r</font> <font color="4444FF">=</font> <font color="#2040a0">irealloc</font><font color="4444FF">(</font><font color="#2040a0">ptr</font>, <font color="#2040a0">size</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1130" href="#line1130">1130</a> 	<font color="#2040a0">err</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">r</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1131" href="#line1131">1131</a>     <font color="4444FF"><strong>}</strong></font>
<a name="line1132" href="#line1132">1132</a>     <font color="#2040a0">UTRACE</font><font color="4444FF">(</font><font color="#2040a0">ptr</font>, <font color="#2040a0">size</font>, <font color="#2040a0">r</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1133" href="#line1133">1133</a>     <font color="#2040a0">malloc_active</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<a name="line1134" href="#line1134">1134</a>     <font color="#2040a0">_MALLOC_UNLOCK</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1135" href="#line1135">1135</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">malloc_xmalloc</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="#2040a0">err</font><font color="4444FF">)</font>
<a name="line1136" href="#line1136">1136</a> 	<font color="#2040a0">wrterror</font><font color="4444FF">(</font><font color="#008000">&quot;out of memory<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1137" href="#line1137">1137</a>     <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">err</font><font color="4444FF">)</font>
<a name="line1138" href="#line1138">1138</a> 	<font color="#2040a0">errno</font> <font color="4444FF">=</font> <font color="#2040a0">ENOMEM</font><font color="4444FF">;</font>
<a name="line1139" href="#line1139">1139</a>     <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">r</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1140" href="#line1140">1140</a> <font color="4444FF"><strong>}</strong></font>
<a name="line1141" href="#line1141">1141</a> 
<a name="line1142" href="#line1142">1142</a> <font color="#444444">/*
<a name="line1143" href="#line1143">1143</a>  * These are the public exported interface routines.
<a name="line1144" href="#line1144">1144</a>  */</font>
<a name="line1145" href="#line1145">1145</a> 
<a name="line1146" href="#line1146">1146</a> <strong>void</strong> <font color="4444FF">*</font>
<a name="line1147" href="#line1147">1147</a> <font color="#2040a0">malloc</font><font color="4444FF">(</font><font color="#2040a0">size_t</font> <font color="#2040a0">size</font><font color="4444FF">)</font>
<a name="line1148" href="#line1148">1148</a> <font color="4444FF"><strong>{</strong></font>
<a name="line1149" href="#line1149">1149</a> 
<a name="line1150" href="#line1150">1150</a>     <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">pubrealloc</font><font color="4444FF">(</font><font color="#2040a0">NULL</font>, <font color="#2040a0">size</font>, <font color="#008000">&quot; in malloc():&quot;</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1151" href="#line1151">1151</a> <font color="4444FF"><strong>}</strong></font>
<a name="line1152" href="#line1152">1152</a> 
<a name="line1153" href="#line1153">1153</a> <strong>void</strong>
<a name="line1154" href="#line1154">1154</a> <font color="#2040a0">free</font><font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">ptr</font><font color="4444FF">)</font>
<a name="line1155" href="#line1155">1155</a> <font color="4444FF"><strong>{</strong></font>
<a name="line1156" href="#line1156">1156</a> 
<a name="line1157" href="#line1157">1157</a>     <font color="#2040a0">pubrealloc</font><font color="4444FF">(</font><font color="#2040a0">ptr</font>, <font color="#FF0000">0</font>, <font color="#008000">&quot; in free():&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1158" href="#line1158">1158</a> <font color="4444FF"><strong>}</strong></font>
<a name="line1159" href="#line1159">1159</a> 
<a name="line1160" href="#line1160">1160</a> <strong>void</strong> <font color="4444FF">*</font>
<a name="line1161" href="#line1161">1161</a> <font color="#2040a0">realloc</font><font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">ptr</font>, <font color="#2040a0">size_t</font> <font color="#2040a0">size</font><font color="4444FF">)</font>
<a name="line1162" href="#line1162">1162</a> <font color="4444FF"><strong>{</strong></font>
<a name="line1163" href="#line1163">1163</a> 
<a name="line1164" href="#line1164">1164</a>     <strong>return</strong> <font color="4444FF">(</font><font color="#2040a0">pubrealloc</font><font color="4444FF">(</font><font color="#2040a0">ptr</font>, <font color="#2040a0">size</font>, <font color="#008000">&quot; in realloc():&quot;</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
<a name="line1165" href="#line1165">1165</a> <font color="4444FF"><strong>}</strong></font>
